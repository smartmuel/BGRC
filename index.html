<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Resource Counter</title>
    <meta name="description" content="A tool to track game resources with counters, images, dice rolling, and customizable settings.">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }

        h1 {
            color: #2c3e50;
            font-size: 1.8em;
            text-align: center;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            flex-direction: column; /* Changed to column to stack input and button group */
            align-items: center;
            margin-bottom: 20px;
        }

        .controls-row {
            display: flex;
            width: 100%;
            max-width: 300px;
            align-items: center; /* Align items vertically in the row */
        }

        .controls-row input[type="text"] {
            flex-grow: 1; /* Input takes up available space */
            margin-right: 5px; /* Space between input and button */
        }

        .controls input[type="file"],
        .controls select {
            margin: 5px;
            width: 100%;
            max-width: 300px;
        }

        .controls button#addButton { /* Style for Add Resource button in controls */
            width: auto; /* Adjust width to content */
            max-width: none; /* Remove max-width */
            flex-shrink: 0; /* Prevent shrinking */
        }


        .button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
        }

        .button-group button {
            flex: 1;
            max-width: 150px;
        }

        #resources {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .resource {
            flex: 0 0 calc(50% - 10px);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            box-sizing: border-box;
            position: relative;
        }

        .resource-image-container {
            width: 100%;
            max-width: 64px;
            /* Updated max-width to 64px */
            max-height: 64px;
            /* Updated max-height to 64px */
            height: auto;
            aspect-ratio: 1;
            overflow: hidden;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .resource-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .counter {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }

        .counter div {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .counter .counter-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        .counter button {
            font-size: 14px;
            width: 36px;
            height: 36px;
            margin: 2px;
            border: none;
            background-color: #3498db;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
        }

        .counter button:hover {
            background-color: #2980b9;
        }

        .counter span {
            font-size: 20px;
            min-width: 40px;
            text-align: center;
            margin: 5px;
            font-weight: bold;
            color: #34495e;
        }

        .resource-name-container input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 80%;
            font-size: 16px;
            box-sizing: border-box;
        }

        .resource-name-container input:focus {
            border-color: #3498db;
            outline: none;
        }

        button {
            padding: 10px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #2ecc71;
            color: #fff;
            margin: 5px;
        }

        button:hover {
            background-color: #27ae60;
        }

        input[type="file"] {
            display: none;
        }

        .custom-increment {
            width: 50px;
            text-align: center;
            margin: 0 5px;
        }

        .settings {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }

        .settings label {
            display: block;
            margin-bottom: 5px;
        }

        .settings input {
            width: calc(100% - 22px);
            margin-bottom: 10px;
        }

        .remove-button {
            background-color: #e74c3c;
            color: #fff;
        }

        .remove-button:hover {
            background-color: #c0392b;
        }

        .hide-image-checkbox,
        .keep-one-modifier-checkbox,
        .use-funny-name-checkbox {
            margin: 10px 0;
        }

        #globalSettings {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1005;
        }

        #globalSettingsButton {
            background-color: #f4f4f9;
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            padding: 0;
            line-height: 1;
        }

        #globalSettingsContent {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            max-width: 300px;
            width: 90vw;
            z-index: 1004;
        }

        .setting-item {
            margin-bottom: 10px;
        }

        .setting-item label {
            display: flex;
            align-items: center;
        }

        .setting-item button { /* Style for buttons in global settings */
            width: 100%;
            margin: 5px 0;
            max-width: none;
        }


        .setting-item input[type="checkbox"] {
            margin-right: 5px;
        }

        .setting-item input[type="number"] {
            width: 60px;
            margin-left: 5px;
        }

        .roll-cube {
            margin-top: 10px;
            text-align: center;
        }

        .roll-cube button {
            font-size: 16px;
            padding: 5px 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .roll-cube button:hover {
            background-color: #2980b9;
        }

        .roll-result {
            font-size: 24px;
            font-weight: bold;
            margin-top: 5px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s;
        }

        .roll-result:hover {
            background-color: #f0f0f0;
        }

        .dice-button {
            font-size: 24px;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }

        .dice-button:hover {
            background-color: #2980b9;
        }

        @keyframes rollAnimation {
            0% {
                transform: rotate(0deg) translateY(0);
            }

            25% {
                transform: rotate(90deg) translateY(-20px);
            }

            50% {
                transform: rotate(180deg) translateY(0);
            }

            75% {
                transform: rotate(270deg) translateY(-20px);
            }

            100% {
                transform: rotate(360deg) translateY(0);
            }
        }

        .rolling {
            animation: rollAnimation 0.5s linear;
        }

        #limitMessage {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #f39c12;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            z-index: 1001;
        }

        #hideAllContainer {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 0;
            position: relative;
            margin-bottom: 10px;
        }

        #hideAllLine {
            position: absolute;
            width: 100%;
            height: 1px;
            background-color: #ddd;
        }

        #hideAllArrow {
            background-color: #f4f4f9;
            padding: 0 10px;
            cursor: pointer;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 600px) {
            .button-group {
                flex-direction: row;
                width: 100%;
            }

            .button-group button {
                max-width: calc(33.33% - 10px);
            }

            .resource {
                flex: 0 0 calc(50% - 5px);
            }

            #globalSettingsContent {
                right: -10px;
                width: calc(100vw - 40px);
            }
        }

        .resource-name-container {
            text-align: center;
            margin-bottom: 10px;
        }

        .resource-name-container input {
            text-align: center;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 80%;
            font-size: 16px;
            box-sizing: border-box;
        }

        .resource-name-container input:focus {
            border-color: #3498db;
            outline: none;
        }

        .resource-name {
            font-size: 16px;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .modifier-toggle {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            font-size: 1em;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background-color: #3498db;
            color: #fff;
            border: none;
        }

        .modifier-toggle:hover {
            background-color: #2980b9;
        }
    </style>
</head>

<body>
    <div id="limitMessage" style="display: none;"></div>
    <h1>Game Resource Counter</h1>
    <div id="hideAllContainer">
        <div id="hideAllLine"></div>
        <span id="hideAllArrow">▼</span>
    </div>
    <div id="globalSettings">
        <button id="globalSettingsButton" onclick="toggleGlobalSettingsVisibility()">⚙️</button>
        <div id="globalSettingsContent">
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="showSettingsGlobal" onchange="toggleGlobalSettings()">
                    Show All Settings
                </label>
            </div>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="disableAllAnimations" onchange="toggleAllAnimations()">
                    Disable All Animations
                </label>
            </div>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="enableGlobalCounterLimit" onchange="toggleGlobalCounterLimit()">
                    Enable Global Counter Limit
                </label>
            </div>
            <div class="setting-item" id="globalCounterLimitContainer" style="display: none;">
                <label>
                    Global Counter Limit:
                    <input type="number" id="globalCounterLimit" value="100" onchange="updateGlobalCounterLimit()">
                </label>
            </div>
            <!-- Global setting to hide funny names -->
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="globalHideFunnyNames" onchange="toggleGlobalHideFunnyNames()" checked>
                    Globally Hide Funny Names
                </label>
            </div>
            <div class="setting-item">
                <button onclick="exportData()" id="exportButton" disabled>Export Data</button>
            </div>
            <div class="setting-item">
                <button onclick="triggerImport()">Import Data</button>
            </div>
        </div>
    </div>
    <div id="controlsContainer">
        <div class="controls">
            <input type="file" id="imageUpload" accept="image/jpeg, image/png, image/gif">
            <div class="controls-row">
                <input type="text" id="resourceName" placeholder="Resource Name">
                <button onclick="addResource()" id="addButton">Add Resource</button>
            </div>
            <select id="exampleSelect">
                <option value="">Select a Game</option>
            </select>
            <button onclick="loadSelectedExample()">Load Game</button>
        </div>
    </div>
    <div id="resources"></div>

    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">

    <script>
        // ... rest of your JavaScript code remains the same ...
        // No changes needed in JS for this UI rearrangement
        let resources = [];
        let unnamedCounter = 1;
        let hasUnsavedChanges = false;
        let showSettingsGlobal = false;
        let globalSettingsVisible = false;
        let hideAllExceptResources = false;
        let inactivityTimer;
        let disableAllAnimations = false;
        let globalCounterLimit = 100;
        let enableGlobalCounterLimit = false;
        let diceSound = null;
        let globalHideFunnyNames = true;
        let previousFunnyNameStates = {};

        const defaultIncrement = 1;
        const defaultIncrement2 = 3;
        const defaultIncrement3 = 5;

        const defaultMinDiceValue = 1;
        const defaultMaxDiceValue = 6;


        function createDiceRollSound() {
            const audioContext = new(window.AudioContext || window.webkitContext)();
            let buffer;

            fetch('sound/rolling_dice.mp3')
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
                .then(decodedBuffer => {
                    buffer = decodedBuffer;
                    diceSound = {
                        play: () => {
                            if (buffer) {
                                const source = audioContext.createBufferSource();
                                source.buffer = buffer;
                                source.connect(audioContext.destination);
                                source.start(0);
                            }
                        }
                    };
                    console.log('Dice sound loaded');
                })
                .catch(error => console.error('Error loading dice roll sound:', error));
        }


        function saveToLocalStorage() {
            const globalConfig = {
                showSettingsGlobal,
                hideAllExceptResources,
                disableAllAnimations,
                globalCounterLimit,
                enableGlobalCounterLimit,
                globalHideFunnyNames,
                previousFunnyNameStates
            };
            localStorage.setItem('boardGameResources', JSON.stringify(resources));
            localStorage.setItem('unnamedCounter', unnamedCounter);
            localStorage.setItem('globalConfig', JSON.stringify(globalConfig));
        }

        function loadFromLocalStorage() {
            const savedResources = localStorage.getItem('boardGameResources');
            const savedGlobalConfig = localStorage.getItem('globalConfig');
            if (savedResources) {
                resources = JSON.parse(savedResources).map(processResourceData);
                unnamedCounter = parseInt(localStorage.getItem('unnamedCounter')) || 1;
                if (savedGlobalConfig) {
                    const config = JSON.parse(savedGlobalConfig);
                    applyGlobalConfig(config);
                    previousFunnyNameStates = config.previousFunnyNameStates || {};
                }
                renderResources();
                updateVisibility();
            }
            checkGlobalCounterLimit();
            if (!diceSound) {
                createDiceRollSound();
            }
        }

        function processResourceData(resourceData) {
            return {
                ...resourceData,
                count: typeof resourceData.count === 'number' ? resourceData.count : 0,
                customIncrement1: typeof resourceData.customIncrement1 === 'number' ? resourceData.customIncrement1 : defaultIncrement,
                customIncrement2: typeof resourceData.customIncrement2 === 'number' ? resourceData.customIncrement2 : defaultIncrement2,
                customIncrement3: typeof resourceData.customIncrement3 === 'number' ? resourceData.customIncrement3 : defaultIncrement3,
                minCount: typeof resourceData.minCount === 'number' ? resourceData.minCount : 0,
                maxCount: resourceData.maxCount === null || resourceData.maxCount === undefined ? Infinity : resourceData.maxCount,
                image: resourceData.image ? resourceData.image : 'default-image.png',
                hideImage: typeof resourceData.hideImage === 'boolean' ? resourceData.hideImage : true,
                keepOneModifier: typeof resourceData.keepOneModifier === 'boolean' ? resourceData.keepOneModifier : true,
                showRollDice: typeof resourceData.showRollDice === 'boolean' ? resourceData.showRollDice : false,
                rollDiceMin: typeof resourceData.rollDiceMin === 'number' ? resourceData.rollDiceMin : defaultMinDiceValue,
                rollDiceMax: typeof resourceData.rollDiceMax === 'number' ? resourceData.rollDiceMax : defaultMaxDiceValue,
                rollDiceIncrement: typeof resourceData.rollDiceIncrement === 'number' ? resourceData.rollDiceIncrement : 1,
                hideCounter: typeof resourceData.hideCounter === 'boolean' ? resourceData.hideCounter : false,
                enableDiceAnimation: typeof resourceData.enableDiceAnimation === 'boolean' ? resourceData.enableDiceAnimation : true,
                numberOfDice: typeof resourceData.numberOfDice === 'number' ? resourceData.numberOfDice : 1,
                rollDiceCustomValues: Array.isArray(resourceData.rollDiceCustomValues) ? resourceData.rollDiceCustomValues : [],
                useCustomDiceValues: typeof resourceData.useCustomDiceValues === 'boolean' ? resourceData.useCustomDiceValues : false,
                useFunnyName: typeof resourceData.useFunnyName === 'boolean' ? resourceData.useFunnyName : false,
                funnyName: resourceData.funnyName || "",
                previousUseFunnyName: typeof resourceData.previousUseFunnyName === 'boolean' ? resourceData.previousUseFunnyName : false
            };
        }


        function applyGlobalConfig(globalConfig) {
            showSettingsGlobal = globalConfig.showSettingsGlobal;
            hideAllExceptResources = globalConfig.hideAllExceptResources;
            disableAllAnimations = globalConfig.disableAllAnimations;
            globalCounterLimit = globalConfig.globalCounterLimit || 100;
            enableGlobalCounterLimit = globalConfig.enableGlobalCounterLimit || false;
            globalHideFunnyNames = globalConfig.globalHideFunnyNames === undefined ? true : globalConfig.globalHideFunnyNames;
            previousFunnyNameStates = globalConfig.previousFunnyNameStates || {};

            // Preserve user's globalHideFunnyNames setting if it exists
            if (globalConfig.globalHideFunnyNames !== undefined) {
                // Only set globalHideFunnyNames if it hasn't been explicitly set by the user yet.
                // We can check if globalHideFunnyNames is still its initial default value (true).
                if (globalHideFunnyNames === true || globalHideFunnyNames === undefined) { // Check for undefined as well for initial load
                    globalHideFunnyNames = globalConfig.globalHideFunnyNames;
                }
            }
            
            document.getElementById('showSettingsGlobal').checked = showSettingsGlobal;
            document.getElementById('disableAllAnimations').checked = disableAllAnimations;
            document.getElementById('globalCounterLimit').value = globalCounterLimit;
            document.getElementById('enableGlobalCounterLimit').checked = enableGlobalCounterLimit;
            document.getElementById('globalHideFunnyNames').checked = globalHideFunnyNames;
            toggleGlobalCounterLimit();
        }

        function addResource() {
            const file = document.getElementById('imageUpload').files[0];
            let name = document.getElementById('resourceName').value.trim() || `Resource ${unnamedCounter++}`;

            const resource = {
                name,
                image: file ? URL.createObjectURL(file) : 'default-image.png',
                count: 0,
                customIncrement1: defaultIncrement,
                customIncrement2: defaultIncrement2,
                customIncrement3: defaultIncrement3,
                minCount: 0,
                maxCount: Infinity,
                hideImage: true,
                keepOneModifier: true,
                showRollDice: false,
                rollDiceMin: defaultMinDiceValue,
                rollDiceMax: defaultMaxDiceValue,
                rollDiceIncrement: 1,
                hideCounter: false,
                enableDiceAnimation: true,
                numberOfDice: 1,
                rollDiceCustomValues: [],
                useCustomDiceValues: false,
                useFunnyName: false,
                funnyName: "",
                previousUseFunnyName: false
            };
            resources.push(resource);
            hasUnsavedChanges = true;
            renderResources();
            saveToLocalStorage();
            checkGlobalCounterLimit();
            document.getElementById('resourceName').value = "";
        }

        function renderResource(resource, index) {
            const container = document.getElementById('resources');
            const existingElement = container.querySelector(`.resource[data-resource-index="${index}"]`);
            const newElementHTML = createResourceHTML(resource, index);
            if (existingElement) {
                existingElement.outerHTML = newElementHTML;
            } else {
                container.insertAdjacentHTML('beforeend', newElementHTML)
            }
        }

        function renderResources() {
            document.getElementById('resources').innerHTML = '';
            resources.forEach((resource, index) => renderResource(resource, index));
            document.getElementById('exportButton').disabled = resources.length === 0;
            updateVisibility();
            attachEventListeners();
        }

        function generateModifierToggle(resource, index) {
            if (resource.hideCounter) return '';
            const modifierIcon = resource.keepOneModifier ? '➕' : '➖';
            return `<div class="modifier-toggle" data-resource-index="${index}" onclick="toggleKeepOneModifier(event, ${index})">${modifierIcon}</div>`
        }

        function generateResourceImage(resource) {
            return resource.hideImage ? '' : `<div class="resource-image-container">
            <img src="${resource.image}" alt="${resource.name}" class="resource-image">
        </div>`;
        }

        function generateResourceNameContainer(resource, index) {
            let displayName = resource.name;
            if (!globalHideFunnyNames && resource.useFunnyName && resource.funnyName) {
                displayName = resource.funnyName;
            }

            return `<div class="resource-name-container">
                    ${showSettingsGlobal
                        ? (resource.useFunnyName
                            ? `<input type="text" placeholder="Funny Resource Name" value="${resource.funnyName}" onblur="updateFunnyName(${index}, this.value)">`
                            : `<input type="text" placeholder="Resource Name" value="${resource.name}" onblur="updateName(${index}, this.value)">`
                          )
                        : `<span class="resource-name">${displayName}</span>`
                    }
                </div>`
        }

        function generateCounter(resource, index) {
            if (resource.hideCounter) return '';
            return `
                <div class="counter">
                    ${!resource.keepOneModifier ? `
                    <div class="counter-buttons">
                        <button onclick="updateCount(event, ${index}, -${resource.customIncrement3})">-${resource.customIncrement3}</button>
                        <button onclick="updateCount(event, ${index}, ${resource.customIncrement3})">+${resource.customIncrement3}</button>
                    </div>
                    ` : ''}
                    <div class="counter-buttons">
                        <button onclick="updateCount(event, ${index}, -${resource.customIncrement1})">-${resource.customIncrement1}</button>
                        <span>${resource.count}</span>
                        <button onclick="updateCount(event, ${index}, ${resource.customIncrement1})">+${resource.customIncrement1}</button>
                    </div>
                    ${!resource.keepOneModifier ? `
                    <div class="counter-buttons">
                        <button onclick="updateCount(event, ${index}, -${resource.customIncrement2})">-${resource.customIncrement2}</button>
                        <button onclick="updateCount(event, ${index}, ${resource.customIncrement2})">+${resource.customIncrement2}</button>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function generateDiceControls(resource, index) {
            if (!resource.showRollDice) return '';
            return `
             <div class="roll-dice" style="display: flex; justify-content: center; align-items: center; margin-top: 10px;">
                 <button class="dice-button" onclick="rollDice(${index})">🎲</button>
                 <div class="roll-result" id="rollResult${index}" style="cursor: pointer; margin-left: 10px;" title="Click to toggle between detailed result and sum">
                    ${resource.useCustomDiceValues && resource.rollDiceCustomValues.length > 0
                        ? Array(resource.numberOfDice).fill(resource.rollDiceCustomValues[resource.rollDiceCustomValues.length - 1]).join(', ')
                        : Array(resource.numberOfDice).fill(resource.rollDiceMax).join(', ')}
                 </div>
            </div>
        `;
        }

        function generateSettings(resource, index) {
            const funnyNameSettingStyle = globalHideFunnyNames ? 'display: none;' : '';
            const funnyNameSettingDisabled = globalHideFunnyNames;

            if (!showSettingsGlobal) return '';
            return `
                <div class="settings">
                    <div class="hide-image-checkbox">
                        Hide Image: <input type="checkbox" ${resource.hideImage ? 'checked' : ''} onchange="updateHideImage(${index}, this.checked)">
                    </div>
                    ${!resource.hideImage ? `<button onclick="changeImage(${index})">Change Image</button>` : ''}
                    <div class="hide-counter-checkbox">
                        Hide Counter: <input type="checkbox" ${resource.hideCounter ? 'checked' : ''} onchange="updateHideCounter(${index}, this.checked)">
                    </div>
                    <div class="keep-one-modifier-checkbox">
                        Keep one Modifier: <input type="checkbox" ${resource.keepOneModifier ? 'checked' : ''} checked onchange="updateKeepOneModifier(${index}, this.checked)">
                    </div>
                    <!-- Use Funny Name Checkbox -->
                    <div class="use-funny-name-checkbox" style="${funnyNameSettingStyle}">
                        Use Funny Name: <input type="checkbox" ${resource.useFunnyName ? 'checked' : ''} onchange="updateUseFunnyName(${index}, this.checked)" ${funnyNameSettingDisabled ? 'disabled' : ''}>
                    </div>
                    <div>
                        Increment 1: <input type="number" class="custom-increment" value="${resource.customIncrement1}" onchange="updateCustomIncrement(${index}, 1, this.value)" min="1">
                    </div>
                    ${!resource.keepOneModifier ? `
                    <div>
                        Increment 2: <input type="number" class="custom-increment" value="${resource.customIncrement2}" onchange="updateCustomIncrement(${index}, 2, this.value)" min="1">
                    </div>
                    <div>
                        Increment 3: <input type="number" class="custom-increment" value="${resource.customIncrement3}" onchange="updateCustomIncrement(${index}, 3, this.value)" min="1">
                    </div>
                    ` : ''}
                    <div>
                        Minimum Count: <input type="number" value="${resource.minCount}" onchange="updateMinCount(${index}, this.value)" >
                    </div>
                    <div>
                        Maximum Count: <input type="number" value="${resource.maxCount === Infinity ? '' : resource.maxCount}" onchange="updateMaxCount(${index}, this.value)">
                    </div>
                    <div class="roll-dice-settings">
                        Show Roll Dice: <input type="checkbox" ${resource.showRollDice ? 'checked' : ''} onchange="updateShowRollDice(${index}, this.checked)">
                    </div>
                    ${resource.showRollDice ? `
                    <div>
                        Use Custom Dice Values: <input type="checkbox" ${resource.useCustomDiceValues ? 'checked' : ''} onchange="updateUseCustomDiceValues(${index}, this.checked)">
                    </div>
                    ${!resource.useCustomDiceValues ? `
                    <div>
                        Roll Dice Min: <input type="number" value="${resource.rollDiceMin}" onchange="updateRollDiceMin(${index}, this.value)" min="1">
                    </div>
                    <div>
                        Roll Dice Max: <input type="number" value="${resource.rollDiceMax}" onchange="updateRollDiceMax(${index}, this.value)" min="1">
                    </div>
                    <div>
                        Roll Dice Increment: <input type="number" value="${resource.rollDiceIncrement}" onchange="updateRollDiceIncrement(${index}, this.value)" min="1">
                    </div>
                    ` : `
                    <div>
                        Custom Dice Values: <input type="text" value="${resource.rollDiceCustomValues.join(', ')}" onchange="updateRollDiceCustomValues(${index}, this.value)">
                    </div>
                    `}
                    <div>
                        Number of Dice: <input type="number" value="${resource.numberOfDice}" min="1" onchange="updateNumberOfDice(${index}, this.value)">
                    </div>
                    <div>
                        Enable Dice Animation: <input type="checkbox" ${resource.enableDiceAnimation ? 'checked' : ''} onchange="updateEnableDiceAnimation(${index}, this.checked)">
                    </div>
                    ` : ''}
                    <button onclick="removeResource(${index})" class="remove-button">Remove</button>
                </div>
            `
        }


        function createResourceHTML(resource, index) {
            const resourceClass = 'resource';
            return `
                <div class="${resourceClass}" data-resource-index="${index}">
                    ${generateModifierToggle(resource, index)}
                    ${generateResourceImage(resource)}
                    ${generateResourceNameContainer(resource, index)}
                    ${generateCounter(resource, index)}
                    ${generateDiceControls(resource, index)}
                    ${generateSettings(resource, index)}
                </div>
             `;
        }

        function toggleKeepOneModifier(event, index) {
            event.stopPropagation();
            const targetResource = resources[index];
            targetResource.keepOneModifier = !targetResource.keepOneModifier;
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
        }


        function updateUseCustomDiceValues(index, use) {
            const targetResource = resources[index];
            targetResource.useCustomDiceValues = use;
            hasUnsavedChanges = true;
            const resultElement = document.getElementById(`rollResult${index}`);
            if (resultElement) {
                if (use && targetResource.rollDiceCustomValues.length > 0) {
                    const lastValue = targetResource.rollDiceCustomValues[targetResource.rollDiceCustomValues.length - 1];
                    resultElement.textContent = Array(targetResource.numberOfDice).fill(lastValue).join(', ');
                } else {
                    resultElement.textContent = Array(targetResource.numberOfDice).fill(targetResource.rollDiceMax).join(', ');
                }
            }
            renderResource(targetResource, index);
            saveToLocalStorage();
        }

        function updateRollDiceCustomValues(index, value) {
            const targetResource = resources[index];
            targetResource.rollDiceCustomValues = value.split(',').map(v => v.trim()).filter(v => v !== '');
            hasUnsavedChanges = true;
            const resultElement = document.getElementById(`rollResult${index}`);
            if (resultElement && targetResource.useCustomDiceValues && targetResource.rollDiceCustomValues.length > 0) {
                const lastValue = targetResource.rollDiceCustomValues[targetResource.rollDiceCustomValues.length - 1];
                resultElement.textContent = Array(targetResource.numberOfDice).fill(lastValue).join(', ');
            }
            saveToLocalStorage();
        }


        function attachEventListeners() {
            document.addEventListener('click', function(event) {
                const target = event.target;

                if (target.matches('.counter button')) {
                    event.stopPropagation();
                }

                if (target.matches('.modifier-toggle')) {
                    const modifier = event.target;
                    const resourceIndex = parseInt(modifier.closest('.resource').dataset.resourceIndex);
                    toggleKeepOneModifier(event, index);
                }
                if (globalSettingsVisible && !target.closest('#globalSettings')) {
                    toggleGlobalSettingsVisibility();
                }
            });


            document.addEventListener('input', function(event) {
                const target = event.target;
                if (target.matches('.resource input')) {
                    const input = target;
                    const resourceElement = input.closest('.resource');
                    const resourceIndex = parseInt(resourceElement.dataset.resourceIndex);
                    const setting = input.parentElement.textContent.trim().split(':')[0].toLowerCase().replace(/\s/g, '');
                    const value = input.type === 'checkbox' ? input.checked : input.value;
                    updateResourceSetting(resourceIndex, setting, value);
                }
            });
        }

        function updateResourceSetting(index, setting, value) {
            const targetResource = resources[index];
            switch (setting) {
                case 'hideimage':
                    updateHideImage(index, value);
                    break;
                case 'hidecounter':
                    updateHideCounter(index, value);
                    break;
                case 'keeponemodifier':
                    updateKeepOneModifier(index, value);
                    break;
                case 'increment1':
                case 'increment2':
                case 'increment3':
                    updateCustomIncrement(index, parseInt(setting.slice(-1)), value);
                    break;
                case 'minimumcount':
                    updateMinCount(index, value);
                    break;
                case 'maximumcount':
                    updateMaxCount(index, value);
                    break;
                case 'showrolldice':
                    updateShowRollDice(index, value);
                    break;
                case 'rolldicemin':
                    updateRollDiceMin(index, value);
                    break;
                case 'rolldicemax':
                    updateRollDiceMax(index, value);
                    break;
                case 'rolldiceincrement':
                    updateRollDiceIncrement(index, value);
                    break;
                case 'numberofdice':
                    updateNumberOfDice(index, value);
                    break;
                case 'enablediceanimation':
                    updateEnableDiceAnimation(index, value);
                    break;
                case 'usecustomdicevalues':
                    updateUseCustomDiceValues(index, value);
                    break;
                case 'customdicevalues':
                    updateRollDiceCustomValues(index, value);
                    break;
                case 'usefunnyname':
                    updateUseFunnyName(index, value);
                    break;
            }
        }

        function updateName(index, newName) {
            const targetResource = resources[index];
            targetResource.name = newName;
            hasUnsavedChanges = true;
            saveToLocalStorage();
            renderResource(targetResource, index);
        }

        function updateFunnyName(index, newFunnyName) {
            const targetResource = resources[index];
            targetResource.funnyName = newFunnyName;
            hasUnsavedChanges = true;
            saveToLocalStorage();
            renderResource(targetResource, index);
        }

        function updateCount(event, index, change) {
            event.stopPropagation();
            const targetResource = resources[index];
            targetResource.count = Math.max(targetResource.minCount, Math.min(targetResource.count + change, targetResource.maxCount));
            hasUnsavedChanges = true;
            const resourceElement = document.querySelector(`.resource[data-resource-index="${index}"] .counter span`);
            if (resourceElement) {
                resourceElement.textContent = targetResource.count;
            }
            saveToLocalStorage();
            setHideAllExceptResources(true);
            resetInactivityTimer();
            checkGlobalCounterLimit();
        }

        function updateCustomIncrement(index, incrementNumber, value) {
            const targetResource = resources[index];
            targetResource[`customIncrement${incrementNumber}`] = Math.max(1, parseInt(value) || 1);
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
        }

        function updateMinCount(index, value) {
            const targetResource = resources[index];
            targetResource.minCount = parseInt(value) || 0;
            targetResource.count = Math.max(targetResource.minCount, targetResource.count);
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
            checkGlobalCounterLimit();
        }

        function updateMaxCount(index, value) {
            const targetResource = resources[index];
            targetResource.maxCount = value === '' ? Infinity : Math.max(targetResource.minCount, parseInt(value) || 0);
            targetResource.count = Math.min(targetResource.maxCount, targetResource.count);
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
            checkGlobalCounterLimit();
        }

        function updateHideImage(index, hide) {
            const targetResource = resources[index];
            targetResource.hideImage = hide;
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
        }

        function updateKeepOneModifier(index, keep) {
            const targetResource = resources[index];
            targetResource.keepOneModifier = keep;
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
        }

        function updateShowRollDice(index, show) {
            const targetResource = resources[index];
            targetResource.showRollDice = show;
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
        }

        function updateRollDiceMin(index, value) {
            const targetResource = resources[index];
            targetResource.rollDiceMin = Math.max(1, parseInt(value) || 1);
            hasUnsavedChanges = true;
            saveToLocalStorage();
        }

        function updateRollDiceMax(index, value) {
            const targetResource = resources[index];
            targetResource.rollDiceMax = Math.max(targetResource.rollDiceMin, parseInt(value) || targetResource.rollDiceMin);
            hasUnsavedChanges = true;
            saveToLocalStorage();
        }

        function updateRollDiceIncrement(index, value) {
            const targetResource = resources[index];
            targetResource.rollDiceIncrement = Math.max(1, parseInt(value) || 1);
            hasUnsavedChanges = true;
            saveToLocalStorage();
        }

        function updateNumberOfDice(index, value) {
            const targetResource = resources[index];
            targetResource.numberOfDice = Math.max(1, parseInt(value) || 1);
            hasUnsavedChanges = true;
            saveToLocalStorage();
            renderResource(targetResource, index);
        }

        function updateHideCounter(index, hide) {
            const targetResource = resources[index];
            targetResource.hideCounter = hide;
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
        }

        function updateEnableDiceAnimation(index, enable) {
            const targetResource = resources[index];
            targetResource.enableDiceAnimation = enable;
            hasUnsavedChanges = true;
            saveToLocalStorage();
        }

        function updateUseFunnyName(index, use) {
            const targetResource = resources[index];
            targetResource.useFunnyName = use;
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
        }

        function displayRollResult(index, results, sum) {
            const targetResource = resources[index];
            const resultElement = document.getElementById(`rollResult${index}`);

            if (targetResource.useCustomDiceValues && targetResource.rollDiceCustomValues.length > 0) {
                resultElement.textContent = results.join(', ');
                resultElement.dataset.detailed = results.join(', ');
                resultElement.onclick = null;
                resultElement.style.cursor = 'default';
                resultElement.title = 'Custom dice values';
            } else {
                resultElement.textContent = results.join(', ');
                resultElement.dataset.sum = sum;
                resultElement.dataset.detailed = results.join(', ');
                resultElement.onclick = () => toggleRollResult(index);
                resultElement.style.cursor = 'pointer';
                resultElement.title = 'Click to toggle between detailed result and sum';
            }
        }

        function toggleRollResult(index) {
            const targetResource = resources[index];
            const resultElement = document.getElementById(`rollResult${index}`);


            if (targetResource.useCustomDiceValues && targetResource.rollDiceCustomValues.length > 0) {
                return;
            }

            if (resultElement.textContent === resultElement.dataset.sum) {
                resultElement.textContent = resultElement.dataset.detailed;
            } else {
                resultElement.textContent = resultElement.dataset.sum;
            }
        }


        function rollDice(index) {
            const targetResource = resources[index];
            let results = [];
            let sum = 0;
            if (!diceSound) {
                createDiceRollSound();
            }
            if (targetResource.useCustomDiceValues && targetResource.rollDiceCustomValues.length > 0) {
                for (let i = 0; i < targetResource.numberOfDice; i++) {
                    const result = targetResource.rollDiceCustomValues[Math.floor(Math.random() * targetResource.rollDiceCustomValues.length)];
                    results.push(result);
                }
            } else {
                const min = targetResource.rollDiceMin;
                const max = targetResource.rollDiceMax;
                const increment = targetResource.rollDiceIncrement;
                const possibleValues = [];
                for (let i = min; i <= max; i += increment) {
                    possibleValues.push(i);
                }
                for (let i = 0; i < targetResource.numberOfDice; i++) {
                    const result = possibleValues[Math.floor(Math.random() * possibleValues.length)];
                    results.push(result);
                    sum += result;
                }
            }

            const resultElement = document.getElementById(`rollResult${index}`);
            const diceButton = document.querySelector(`.resource[data-resource-index="${index}"] .dice-button`);


            if (targetResource.enableDiceAnimation && !disableAllAnimations) {
                if (diceSound && diceSound.play) {
                    diceSound.play();
                }

                diceButton.classList.add('rolling');
                resultElement.textContent = '...';
                setTimeout(() => {
                    diceButton.classList.remove('rolling');
                    displayRollResult(index, results, sum);
                }, 1000);
            } else {
                displayRollResult(index, results, sum);
            }
            setHideAllExceptResources(true);
            resetInactivityTimer();
        }


        function changeImage(index) {
            const targetResource = resources[index];
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/jpeg, image/png, image/gif';
            fileInput.onchange = event => {
                const file = event.target.files[0];
                if (file) {
                    targetResource.image = URL.createObjectURL(file);
                    hasUnsavedChanges = true;
                    renderResource(targetResource, index);
                    saveToLocalStorage();
                }
            };
            fileInput.click();
        }

        function removeResource(index) {
            console.log("removeResource called for index:", index);
            const confirmed = confirm('Are you sure you want to remove this resource?');
            if (confirmed) {
                console.log("Confirmed removal");
                console.log("Resources before splice:", resources);
                resources.splice(index, 1);
                console.log("Resources after splice:", resources);
                hasUnsavedChanges = true;
                renderResources();
                saveToLocalStorage();
                checkGlobalCounterLimit();
            } else {
                console.log("Removal cancelled");
            }
        }

        function exportData() {
            const exportData = {
                resources: resources,
                globalConfig: {
                    showSettingsGlobal,
                    hideAllExceptResources,
                    disableAllAnimations,
                    globalCounterLimit,
                    enableGlobalCounterLimit,
                    globalHideFunnyNames,
                    previousFunnyNameStates
                }
            };
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'resources.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function triggerImport() {
            document.getElementById('importFile').click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        resources = importedData.resources.map(processResourceData);
                        if (importedData.globalConfig) {
                            applyGlobalConfig(importedData.globalConfig);
                        }
                        hasUnsavedChanges = false;
                        setHideAllExceptResources(true);
                        renderResources();
                        saveToLocalStorage();
                        checkGlobalCounterLimit();
                    } catch (error) {
                        alert('Error importing data. Please make sure the file is valid JSON.');
                        console.error('Import Error:', error);
                    }
                };
                reader.readAsText(file);
            }
        }

        function populateExampleDropdown() {
            const select = document.getElementById('exampleSelect');
            select.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "Select a Game";
            select.appendChild(defaultOption);

            const clearOption = document.createElement('option');
            clearOption.value = 'clear';
            clearOption.textContent = 'Clear';
            select.appendChild(clearOption);

            fetch('examples/example_list.json')
                .then(response => response.json())
                .then(exampleNames => {
                    exampleNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = `${name}.json`;
                        option.textContent = name;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading example list:', error));
        }

        function loadSelectedExample() {
            const exampleSelect = document.getElementById('exampleSelect');
            const exampleName = exampleSelect.value;
            console.log("loadSelectedExample called with example:", exampleName);
        
            // Check if there are resources or unsaved changes
            if (exampleName !== 'clear' && (resources.length > 0 || hasUnsavedChanges)) {
                const confirmation = confirm("Loading a new game will clear your current resources. Are you sure you want to continue?");
                if (!confirmation) {
                    console.log("Load game cancelled by user.");
                    return; // Exit the function if the user cancels
                }
                console.log("User confirmed load game, proceeding...");
            }
        
            if (exampleName === 'clear') {
                console.log("Clear example selected");
                if (confirm("Are you sure you want to clear all resources? This action cannot be undone.")) {
                    console.log("Confirmed clear action");
                    console.log("Resources before clear:", resources);
                    resources = [];
                    console.log("Resources after clear:", resources);
                    hasUnsavedChanges = false;
                    renderResources();
                    saveToLocalStorage();
                    checkGlobalCounterLimit();
                    console.log("Clear action completed");
                } else {
                    console.log("Clear action cancelled");
                }
            } else if (exampleName) {
                fetch(`examples/${exampleName}`)
                    .then(response => response.json())
                    .then(data => {
                        let resourcesData = Array.isArray(data) ? data : data.resources;
                        resources = resourcesData.map(processResourceData);
                        if (data.globalConfig) {
                            applyGlobalConfig(data.globalConfig);
                        }
                        hasUnsavedChanges = false;
                        setHideAllExceptResources(true);
                        renderResources();
                        saveToLocalStorage();
                        checkGlobalCounterLimit();
                        exampleSelect.value = "";
                    })
                    .catch(error => {
                        console.error('Failed to load example:', error);
                        alert('Failed to load example');
                    });
            }
        }

        function refreshExamples() {
            populateExampleDropdown();
        }

        function toggleGlobalSettings() {
            showSettingsGlobal = document.getElementById('showSettingsGlobal').checked;
            renderResources();
            saveToLocalStorage();
        }

        function toggleGlobalSettingsVisibility() {
            globalSettingsVisible = !globalSettingsVisible;
            const content = document.getElementById('globalSettingsContent');
            content.style.display = globalSettingsVisible ? 'block' : 'none';
        }

        document.getElementById('hideAllArrow').addEventListener('click', function() {
            toggleHideAllExceptResources();
        });

        function toggleHideAllExceptResources() {
            hideAllExceptResources = !hideAllExceptResources;
            updateVisibility();
            saveToLocalStorage();
            document.getElementById('hideAllArrow').textContent = hideAllExceptResources ? '▼' : '▲';
        }

        function setHideAllExceptResources(value) {
            hideAllExceptResources = value;
            updateVisibility();
            saveToLocalStorage();
            document.getElementById('hideAllArrow').textContent = value ? '▼' : '▲';
        }

        function updateVisibility() {
            const controlsContainer = document.getElementById('controlsContainer');
            controlsContainer.style.display = hideAllExceptResources ? 'none' : 'block';
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                setHideAllExceptResources(false);
            }, 5 * 60 * 1000);
        }

        function toggleAllAnimations() {
            disableAllAnimations = document.getElementById('disableAllAnimations').checked;
            saveToLocalStorage();
        }

        function updateGlobalCounterLimit() {
            globalCounterLimit = parseInt(document.getElementById('globalCounterLimit').value) || 100;
            saveToLocalStorage();
            checkGlobalCounterLimit();
        }

        function toggleGlobalCounterLimit() {
            enableGlobalCounterLimit = document.getElementById('enableGlobalCounterLimit').checked;
            const globalCounterLimitContainer = document.getElementById('globalCounterLimitContainer');
            globalCounterLimitContainer.style.display = enableGlobalCounterLimit ? 'block' : 'none';
            saveToLocalStorage();
            checkGlobalCounterLimit();
        }

        function toggleGlobalHideFunnyNames() {
            globalHideFunnyNames = document.getElementById('globalHideFunnyNames').checked;

            if (globalHideFunnyNames) {
                // Store current funny name states
                resources.forEach((resource, index) => {
                    previousFunnyNameStates[index] = resource.useFunnyName;
                    resource.previousUseFunnyName = resource.useFunnyName; // Backup current state for restore
                    resource.useFunnyName = false; // Force disable funny names
                });
            } else {
                // Restore previous funny name states
                resources.forEach((resource, index) => {
                    resource.useFunnyName = resource.previousUseFunnyName; // Restore from backup
                });
            }

            renderResources();
            saveToLocalStorage();
        }


        function checkGlobalCounterLimit() {
            if (!enableGlobalCounterLimit) {
                document.getElementById('limitMessage').style.display = 'none';
                return;
            }

            const totalCount = resources.reduce((sum, resource) => sum + resource.count, 0);
            const limitMessage = document.getElementById('limitMessage');
            if (totalCount > globalCounterLimit) {
                limitMessage.textContent = `Global counter limit (${globalCounterLimit}) exceeded!`;
                limitMessage.style.display = 'block';
            } else {
                limitMessage.style.display = 'none';
            }
        }

        window.addEventListener('beforeunload', (event) => {
            if (hasUnsavedChanges) {
                event.preventDefault();
                event.returnValue = '';
                setTimeout(() => {
                    localStorage.clear();
                }, 0);
                return '';
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            refreshExamples();
            loadFromLocalStorage();
            resetInactivityTimer();
            document.getElementById('enableGlobalCounterLimit').checked = enableGlobalCounterLimit;
            toggleGlobalCounterLimit();
            document.getElementById('globalHideFunnyNames').checked = globalHideFunnyNames;
        });

        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);

    </script>
</body>

</html>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Resource Counter</title>
    <meta name="description"
        content="A tool to track game resources with counters, images, dice rolling, and customizable settings.">
    <style>
        :root {
            --button-padding: 10px;
            --button-border-radius: 4px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }

        h1 {
            color: #2c3e50;
            font-size: 1.8em;
            text-align: center;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .controls-row {
            display: flex;
            width: 100%;
            max-width: 300px;
            align-items: center;
        }

        .controls-row input[type="text"] {
            flex-grow: 1;
            margin-right: 5px;
        }

        .controls input[type="file"],
        .controls select {
            margin: 5px;
            width: 100%;
            max-width: 300px;
        }

        .controls button#addButton {
            width: auto;
            max-width: none;
            flex-shrink: 0;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
        }

        .button-group button {
            flex: 1;
            max-width: 150px;
        }

        #resources {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .resource {
            flex: 0 0 calc(50% - 10px);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            box-sizing: border-box;
            position: relative;
        }

        .resource-image-container {
            width: 100%;
            max-width: 64px;
            max-height: 64px;
            height: auto;
            aspect-ratio: 1;
            overflow: hidden;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9f4f9;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .resource-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .counter {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }

        .counter div {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .counter .counter-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        .counter button {
            font-size: 14px;
            width: 36px;
            height: 36px;
            margin: 2px;
            border: none;
            background-color: #3498db;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
        }

        .counter button:hover {
            background-color: #2980b9;
        }

        .counter span {
            font-size: 20px;
            min-width: 40px;
            text-align: center;
            margin: 5px;
            font-weight: bold;
            color: #34495e;
        }

        .resource-name-container input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 80%;
            font-size: 16px;
            box-sizing: border-box;
        }

        .resource-name-container input:focus {
            border-color: #3498db;
            outline: none;
        }

        button {
            padding: var(--button-padding);
            font-size: 14px;
            border: none;
            border-radius: var(--button-border-radius);
            cursor: pointer;
            background-color: #2ecc71;
            color: #fff;
            margin: 5px;
        }

        button:hover {
            background-color: #27ae60;
        }

        input[type="file"] {
            display: none;
        }

        .custom-increment {
            width: 50px;
            text-align: center;
            margin: 0 5px;
        }

        .settings {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }

        .settings label {
            display: block;
            margin-bottom: 5px;
        }

        .settings input {
            width: calc(100% - 22px);
            margin-bottom: 10px;
        }

        .remove-button {
            background-color: #e74c3c;
            color: #fff;
        }

        .remove-button:hover {
            background-color: #c0392b;
        }

        .hide-image-checkbox,
        .keep-one-modifier-checkbox,
        .use-funny-name-checkbox {
            margin: 10px 0;
        }

        #globalSettings {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1005;
        }

        #globalSettingsButton {
            background-color: #f4f4f9;
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            padding: 0;
            line-height: 1;
        }

        #globalSettingsContent {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            max-width: 300px;
            width: 90vw;
            z-index: 1004;
        }

        .setting-item {
            margin-bottom: 10px;
        }

        .setting-item button {
            width: 100%;
            margin: 5px 0;
            max-width: none;
        }

        .setting-item input[type="checkbox"] {
            margin-right: 5px;
        }

        .setting-item input[type="number"] {
            width: 60px;
            margin-left: 5px;
        }

        .roll-cube {
            margin-top: 10px;
            text-align: center;
        }

        .roll-cube button {
            font-size: 16px;
            padding: 5px 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .roll-cube button:hover {
            background-color: #2980b9;
        }

        .roll-result {
            font-size: 24px;
            font-weight: bold;
            margin-top: 5px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s; /* Keep the transition, but remove hover bg */
        }

        /* REMOVED HOVER BACKGROUND COLOR */
        /*.roll-result:hover {
            background-color: #f0f0f0;
        }*/

        .dice-button {
            font-size: 24px;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }

        .dice-button:hover {
            background-color: #2980b9;
        }

        @keyframes rollAnimation {
            0% {
                transform: rotate(0deg) translateY(0);
            }

            25% {
                transform: rotate(90deg) translateY(-20px);
            }

            50% {
                transform: rotate(180deg) translateY(0);
            }

            75% {
                transform: rotate(270deg) translateY(-20px);
            }

            100% {
                transform: rotate(360deg) translateY(0);
            }
        }

        .rolling {
            animation: rollAnimation 0.5s linear;
        }

        #limitMessage {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #f39c12;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            z-index: 1001;
        }

        #hideAllContainer {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 0;
            position: relative;
            margin-bottom: 10px;
        }

        #hideAllLine {
            position: absolute;
            width: 100%;
            height: 1px;
            background-color: #ddd;
        }

        #hideAllArrow {
            background-color: #f4f4f9;
            padding: 0 10px;
            cursor: pointer;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 600px) {
            .button-group {
                flex-direction: row;
                width: 100%;
            }

            .button-group button {
                max-width: calc(33.33% - 10px);
            }

            .resource {
                flex: 0 0 calc(50% - 5px);
            }

            #globalSettingsContent {
                right: -10px;
                width: calc(100vw - 40px);
            }
        }

        .resource-name-container {
            text-align: center;
            margin-bottom: 10px;
        }

        .resource-name-container input {
            text-align: center;
        }

        .resource-name {
            font-size: 16px;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .modifier-toggle {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            font-size: 1em;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background-color: #3498db;
            color: #fff;
            border: none;
        }

        .modifier-toggle:hover {
            background-color: #2980b9;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #333;
            color: #f0f0f0;
        }

        body.dark-mode h1 {
            color: #fff;
        }

        body.dark-mode .resource {
            background-color: #444;
            border-color: #666;
            box-shadow: 0 4px 6px rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .settings {
            background-color: #555;
            color: #f0f0f0;
            border-color: #666;
        }

        body.dark-mode .resource-name-container input {
            background-color: #555;
            color: #f0f0f0;
            border-color: #666;
        }

        body.dark-mode .resource-name-container input:focus {
            border-color: #3498db;
            outline: none;
        }

        body.dark-mode #globalSettingsButton {
            background-color: #444;
            color: #f0f0f0;
            border-color: #666;
        }

        body.dark-mode #globalSettingsContent {
            background-color: #444;
            color: #f0f0f0;
            border-color: #666;
        }

        body.dark-mode #hideAllArrow {
            background-color: #333;
        }

        body.dark-mode .counter span {
            color: #f0f0f0;
        }

        body.dark-mode #serverClientButton {
            background-color: #444;
            color: #f0f0f0;
            border-color: #666;
        }

        body.dark-mode #serverClientContent {
            background-color: #444;
            color: #f0f0f0;
            border-color: #666;
        }

        body.dark-mode #serverClientContent input[type="text"],
        body.dark-mode #serverClientContent select {
            background-color: #555;
            color: #f0f0f0;
            border-color: #666;
        }

        body.dark-mode #serverClientContent input[type="text"]:focus,
        body.dark-mode #serverClientContent select:focus {
            border-color: #3498db;
            outline: none;
        }

        body.dark-mode #serverClientContent button {
            background-color: #2ecc71;
        }

        body.dark-mode #serverClientContent button:hover {
            background-color: #27ae60;
        }

        body.dark-mode #statusWindowContainer #statusWindowButton {
            background-color: #444;
            color: #f0f0f0;
            border-color: #666;
        }

        body.dark-mode #statusWindowContainer #statusWindow {
            background-color: #444;
            color: #f0f0f0;
            border-color: #666;
        }

        .dark-mode .status-item {
            border-bottom: 1px dotted #555;
            /* Darker border in dark mode */
        }

        #serverClientSettings {
            position: fixed;
            top: 60px;
            right: 10px;
            z-index: 1005;
        }

        #serverClientButton {
            background-color: #f4f4f9;
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            padding: 0;
            line-height: 1;
        }

        #serverClientContent {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            max-width: 300px;
            width: 90vw;
            z-index: 1004;
        }

        .firebase-fields {
            display: none; /* Initially hidden */
        }

        /* Status Window Styles */
        #statusWindowContainer {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1005;
        }

        #statusWindowButton {
            background-color: #f4f4f9;
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            padding: 0;
            line-height: 1;
        }

        #statusWindow {
            display: none;
            position: absolute;
            left: 0;
            top: 100%; /* Positioned below the button */
            background-color: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            max-width: 400px; /* Adjust as needed */
            width: 90vw;
            z-index: 1004;
            overflow-y: auto; /* For scrollable content if needed */
            max-height: 300px; /* Limit height and enable scroll */
        }

        .status-item {
            padding: 5px 0;
            border-bottom: 1px dotted #ddd;
            margin-bottom: 5px;
        }

        .status-item:last-child {
            border-bottom: none; /* No border for the last item */
            margin-bottom: 0;
        }

        body.dark-mode #statusWindowContainer #statusWindowButton {
            background-color: #444;
            color: #f0f0f0;
            border-color: #666;
        }

        body.dark-mode #statusWindowContainer #statusWindow {
            background-color: #444;
            color: #f0f0f0;
            border-color: #666;
        }

        .dark-mode .status-item {
            border-bottom: 1px dotted #555;
            /* Darker border in dark mode */
        }

        #qrcodeCanvas {
            margin-top: 10px;
            text-align: center;
        }

        .other-clients-counts {
            font-size: 0.8em;
            color: #777;
            margin-top: 2px; /* Reduced margin-top for compactness */
            text-align: left; /* Align text to the left within the container */
            width: 100%; /* Ensure it takes full width of counter */
            box-sizing: border-box; /* Include padding and border in element's total width and height */
            padding: 0 5px; /* Reduced padding for compactness */
            display: none; /* Initially hidden, shown only when counts are available */
            line-height: 1.2; /* Slightly reduced line-height for compactness */
        }

        body.dark-mode .other-clients-counts {
            color: #aaa; /* Lighter color in dark mode */
        }


    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

</head>

<body data-new-gr-c-s-check-loaded="14.1098.0.0" data-gr-ext-installed="">
    <div id="statusWindowContainer">
        <button id="statusWindowButton" onclick="toggleStatusWindowVisibility()">📊</button>
        <div id="statusWindow">
            <!-- Client status will be displayed here -->
        </div>
    </div>
    <div id="limitMessage" style="display: none;"></div>
    <h1>Game Resource Counter</h1>
    <div id="hideAllContainer">
        <div id="hideAllLine"></div>
        <span id="hideAllArrow" onclick="toggleHideAllExceptResources()">▼</span>
    </div>
    <div id="globalSettings">
        <button id="globalSettingsButton" onclick="toggleGlobalSettingsVisibility()">⚙️</button>
        <div id="globalSettingsContent">
            <h3>User Preferences</h3>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="showSettingsGlobal" onchange="toggleGlobalSettings()">
                    Show All Settings
                </label>
            </div>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="disableAllAnimations" onchange="toggleAllAnimations()">
                    Disable All Animations
                </label>
            </div>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                    Dark Mode
                </label>
            </div>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="globalHideFunnyNames" onchange="toggleGlobalHideFunnyNames()" checked>
                    Globally Hide Funny Names
                </label>
            </div>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="globalHideAllImages" onchange="toggleGlobalHideAllImages()">
                    Globally Hide All Images
                </label>
            </div>
            <hr/>
            <h3>Game Settings</h3>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="enableGlobalCounterLimit" onchange="toggleGlobalCounterLimit()">
                    Enable Global Counter Limit
                </label>
            </div>
            <div class="setting-item" id="globalCounterLimitContainer" style="display: none;">
                <label>
                    Global Counter Limit:
                    <input type="number" id="globalCounterLimit" value="100" onchange="updateGlobalCounterLimit()">
                </label>
            </div>
            <hr/>
            <h3>Data Options</h3>
            <div class="setting-item">
                <button onclick="exportData()" id="exportButton" disabled>Export Data</button>
            </div>
            <div class="setting-item">
                <button onclick="triggerImport()">Import Data</button>
            </div>
        </div>
    </div>

    <div id="serverClientSettings">
        <button id="serverClientButton" onclick="toggleServerClientSettingsVisibility()">🌐</button>
        <div id="serverClientContent">
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="showFirebaseFieldsToggle" onchange="toggleFirebaseConfigVisibility()">
                    Show Firebase Config Fields
                </label>
            </div>
            <div class="setting-item firebase-fields">
                <h3>Firebase Credentials</h3>
            </div>
            <div class="setting-item firebase-fields">
                <label for="apiKey">apiKey:</label>
                <input type="text" id="apiKey" placeholder="Your Firebase apiKey">
            </div>
            <div class="setting-item firebase-fields">
                <label for="authDomain">authDomain:</label>
                <input type="text" id="authDomain" placeholder="Your authDomain">
            </div>
            <div class="setting-item firebase-fields">
                <label for="databaseURL">databaseURL:</label>
                <input type="text" id="databaseURL" placeholder="Your databaseURL">
            </div>
            <div class="setting-item firebase-fields">
                <label for="projectId">projectId:</label>
                <input type="text" id="projectId" placeholder="Your projectId">
            </div>
            <div class="setting-item firebase-fields">
                <label for="storageBucket">storageBucket:</label>
                <input type="text" id="storageBucket" placeholder="Your storageBucket">
            </div>
            <div class="setting-item firebase-fields">
                <label for="messagingSenderId">messagingSenderId:</label>
                <input type="text" id="messagingSenderId" placeholder="Your messagingSenderId">
            </div>
            <div class="setting-item firebase-fields">
                <label for="appId">appId:</label>
                <input type="text" id="appId" placeholder="Your appId">
            </div>
            <div class="setting-item firebase-fields">
                <button id="saveFirebaseConfig">Save Firebase Config</button>
            </div>
            <div class="setting-item">
                <button onclick="exportFirebaseConfig()">Export Firebase Config</button>
            </div>
            <div class="setting-item">
                <button onclick="triggerImportFirebaseConfig()">Import Firebase Config</button>
                <input type="file" id="importFirebaseFile" accept=".json" style="display: none;" onchange="importFirebaseConfig(event)">
            </div>
            <hr/> <!-- Separator for Firebase settings and Server/Client Mode -->
            <div class="setting-item">
                <label>
                    Client Name:
                    <input type="text" id="clientNameInput" placeholder="Enter your name">
                </label>
            </div>
            <div class="setting-item">
                <label>
                    Mode:
                    <select id="serverClientMode">
                        <option value="client" selected>Client</option>
                        <option value="server">Server</option>
                        <option value="local">Local</option>
                    </select>
                </label>
            </div>
            <div class="setting-item" id="sessionIdContainer" style="display: block;">
                <label>
                    Session ID:
                    <input type="text" id="sessionId" placeholder="Enter Session ID">
                    <button id="importSdkConfigButton" onclick="triggerImportSdkConfig()">Import SDK Config & Join</button>
                    <input type="file" id="importSdkConfigFile" accept=".json" style="display: none;" onchange="importSdkConfigAndJoin(event)">
                </label>
                <button id="connectButton">Connect</button>
            </div>
            <div class="setting-item" id="newSessionContainer" style="display: none;">
                <button id="startButton">Start New Session</button>
            </div>
            <div class="setting-item" id="serverIDDisplayContainer" style="display: none;">
                <label for="serverIDDisplay">Session ID:</label>
                <input type="text" id="serverIDDisplay" value="" readonly>
                <button id="exportSdkConfigButton" onclick="exportSdkConfigWithSession()">Export SDK Config</button>
            </div>
            <div class="setting-item" id="qrcodeCanvas" style="display: none;">
                <!-- QR Code will be rendered here -->
            </div>
        </div>
    </div>

    <div id="controlsContainer">
        <div class="controls">
            <input type="file" id="imageUpload" accept="image/jpeg, image/png, image/gif">
            <div class="controls-row">
                <input type="text" id="resourceName" placeholder="Resource Name">
                <button id="addButton">Add Resource</button>
            </div>
            <select id="exampleSelect">
                <option value="">Select a Game</option>
            </select>
            <button id="loadExampleButton">Load Game</button>
        </div>
    </div>
    <div id="resources"></div>

    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">

    <script>
        const STATIC_ASSET_URL = 'https://smartmuel.github.io/BGRC_Resources';

        let db; // Firebase database instance, will be initialized later

        let resources = [];
        let unnamedCounter = 1;
        let hasUnsavedChanges = false;
        let showSettingsGlobal = false;
        let globalSettingsVisible = false;
        let hideAllExceptResources = false;
        let inactivityTimer;
        let disableAllAnimations = false;
        let globalCounterLimit = 100;
        let enableGlobalCounterLimit = false;
        let diceSound = null;
        let globalHideFunnyNames = true;
        let previousFunnyNameStates = {};
        let serverClientSettingsVisible = false;
        let serverClientMode = 'client';
        let sessionId = null;
        let clientId = generateClientId();
        let serverListeners = {};
        let clientListeners = {};
        let exampleDropdownPopulated = false;
        let clientName = localStorage.getItem('clientName') || '';
        let configSavedToServer = false;
        let initialLoad = true;
        let statusWindowVisible = false; // Track status window visibility
        let clientsInSession = {}; // Store client names by ID
        let sdkExported = false; // Flag to prevent double export
        let qrcode = null; // QR code instance
        let otherClientsResourceCounts = {}; // Store other clients' resource counts
        let globalHideAllImages = false; // New global setting to hide all images

        // Brainrot names list
        const brainrotNames = ["Simp", "Gooner", "Gyatt", "Rizzler", "Sigma", "Beta", "Skibidi", "Ohio", "Fanum", "Based", "Cringe", "NPC", "Chad", "Soyjak", "Doomer", "Bloomer", "Zoomer", "Boomer"];

        function getRandomBrainrotName() {
            return brainrotNames[Math.floor(Math.random() * brainrotNames.length)];
        }

        function toggleStatusWindowVisibility() {
            statusWindowVisible = !statusWindowVisible;
            document.getElementById('statusWindow').style.display = statusWindowVisible ? 'block' : 'none';
            if (statusWindowVisible && serverClientMode !== 'local') {
                fetchAndDisplayClientStatus();
            }
        }

        async function fetchAndDisplayClientStatus() {
            if (!sessionId || !['client', 'server'].includes(serverClientMode)) {
                console.warn("Client status not available in local mode or without a session.");
                document.getElementById('statusWindow').innerHTML = "<p>Status not available in local mode or without a session.</p>";
                return;
            }

            const statusWindowContent = document.getElementById('statusWindow');
            statusWindowContent.innerHTML = "<p>Loading client status...</p>";

            try {
                const clientCountsSnapshot = await db.ref(`sessions/${sessionId}/client_counts`).get();
                const clientCountsData = clientCountsSnapshot.val() || {};
                const configSnapshot = await db.ref(`sessions/${sessionId}/config`).get();
                const configData = configSnapshot.val() || {};


                let statusHTML = '';
                for (const clientFirebaseId in clientCountsData) {
                    if (clientFirebaseId === clientId) continue;
                    const clientCounts = clientCountsData[clientFirebaseId];
                    const currentClientName = clientsInSession[clientFirebaseId] || 'Unknown Client';

                    statusHTML += `<div class="status-item"><h4>Client: ${currentClientName}</h4><ul>`;

                    for (const resourceIndex in configData) {
                        if (configData.hasOwnProperty(resourceIndex)) {
                            const count = clientCounts ? clientCounts[resourceIndex] : undefined;
                            const resource = configData[resourceIndex];

                            if (resource) {
                                const resourceDisplayName = !globalHideFunnyNames && resource.useFunnyName && resource.funnyName ? resource.funnyName : resource.name;
                                statusHTML += `<li>${resourceDisplayName}: ${count !== undefined ? count : 'N/A'}</li>`;
                            }
                        }
                    }
                    statusHTML += `</ul></div>`;
                }

                if (statusHTML === '') {
                    statusHTML = "<p>No other clients connected or no data available.</p>";
                }

                statusWindowContent.innerHTML = statusHTML;

            } catch (error) {
                console.error("Error fetching client status:", error);
                statusWindowContent.innerHTML = "<p>Error loading client status.</p>";
            }
        }


        function toggleServerClientSettingsVisibility() {
            serverClientSettingsVisible = !serverClientSettingsVisible;
            document.getElementById('serverClientContent').style.display = serverClientSettingsVisible ? 'block' : 'none';
        }

        function initializeFirebaseWithUserInput() {
            const firebaseConfigFromInput = {
                apiKey: document.getElementById('apiKey').value,
                authDomain: document.getElementById('authDomain').value,
                databaseURL: document.getElementById('databaseURL').value,
                projectId: document.getElementById('projectId').value,
                storageBucket: document.getElementById('storageBucket').value,
                messagingSenderId: document.getElementById('messagingSenderId').value,
                appId: document.getElementById('appId').value
            };

            const missingFields = Object.entries(firebaseConfigFromInput)
                .filter(([key, value]) => !value)
                .map(([key]) => key);

            if (missingFields.length > 0) {
                console.warn(`Firebase configuration missing fields: ${missingFields.join(', ')}`);
                return false;
            }

            try {
                firebase.initializeApp(firebaseConfigFromInput);
                db = firebase.database();
                console.log("Firebase Initialized Successfully with user credentials.");
                saveFirebaseConfigToCache(firebaseConfigFromInput);
                return true;
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                console.warn("Firebase Initialization Failed. Check console for details.");
                return false;
            }
        }

        function exportFirebaseConfig() {
            const firebaseConfig = {
                apiKey: document.getElementById('apiKey').value,
                authDomain: document.getElementById('authDomain').value,
                databaseURL: document.getElementById('databaseURL').value,
                projectId: document.getElementById('projectId').value,
                storageBucket: document.getElementById('storageBucket').value,
                messagingSenderId: document.getElementById('messagingSenderId').value,
                appId: document.getElementById('appId').value
            };

            const configStr = JSON.stringify(firebaseConfig, null, 2);
            const blob = new Blob([configStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'firebase-config.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function triggerImportFirebaseConfig() {
            document.getElementById('importFirebaseFile').click();
        }

        function importFirebaseConfig(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedConfig = JSON.parse(e.target.result);
                    if (typeof importedConfig === 'object' &&
                        importedConfig.apiKey && importedConfig.authDomain && importedConfig.databaseURL &&
                        importedConfig.projectId && importedConfig.appId) {

                        document.getElementById('apiKey').value = importedConfig.apiKey || '';
                        document.getElementById('authDomain').value = importedConfig.authDomain || '';
                        document.getElementById('databaseURL').value = importedConfig.databaseURL || '';
                        document.getElementById('projectId').value = importedConfig.projectId || '';
                        document.getElementById('storageBucket').value = importedConfig.storageBucket || '';
                        document.getElementById('messagingSenderId').value = importedConfig.messagingSenderId || '';
                        document.getElementById('appId').value = importedConfig.appId || '';

                        console.log("Firebase configuration imported successfully!");
                        if (initializeFirebaseWithUserInput()) {
                            console.log("Firebase re-initialized after import.");
                        }
                    } else {
                        console.warn("Invalid Firebase configuration file.");
                    }
                } catch (error) {
                    console.warn("Error importing Firebase configuration.");
                    console.error("Firebase config import error:", error);
                }
            };
            reader.onerror = function(error) {
                console.warn("Error reading the Firebase configuration file.");
                console.error("File read error:", error);
            };
            reader.readAsText(file);
        }

        function saveFirebaseConfigToCache(config) {
            localStorage.setItem('firebaseConfig', JSON.stringify(config));
        }

        function loadFirebaseConfigFromCache() {
            const cachedConfig = localStorage.getItem('firebaseConfig');
            if (cachedConfig) {
                const config = JSON.parse(cachedConfig);
                document.getElementById('apiKey').value = config.apiKey || '';
                document.getElementById('authDomain').value = config.authDomain || '';
                document.getElementById('databaseURL').value = config.databaseURL || '';
                document.getElementById('projectId').value = config.projectId || '';
                document.getElementById('storageBucket').value = config.storageBucket || '';
                document.getElementById('messagingSenderId').value = config.messagingSenderId || '';
                document.getElementById('appId').value = config.appId || '';
            }
        }


        function toggleFirebaseConfigVisibility() {
            const firebaseFields = document.querySelectorAll('.firebase-fields');
            const showFirebaseFieldsToggle = document.getElementById('showFirebaseFieldsToggle');
            const displayStyle = showFirebaseFieldsToggle.checked ? 'block' : 'none';
            firebaseFields.forEach(field => {
                field.style.display = displayStyle;
            });
        }


        if (clientName) {
            document.getElementById('clientNameInput').value = clientName;
        }


        const defaultIncrement = 1;
        const defaultIncrement2 = 3;
        const defaultIncrement3 = 5;
        const defaultMinDiceValue = 1;
        const defaultMaxDiceValue = 6;


        async function createDiceRollSound() {
            const audioContext = new(window.AudioContext || window.webkitContext)();
            let buffer;

            try {
                const response = await fetch(`${STATIC_ASSET_URL}/sound/rolling_dice.mp3`);
                const arrayBuffer = await response.arrayBuffer();
                const decodedBuffer = await audioContext.decodeAudioData(arrayBuffer);
                buffer = decodedBuffer;
                return {
                    play: () => {
                        if (buffer) {
                            const source = audioContext.createBufferSource();
                            source.buffer = buffer;
                            source.connect(audioContext.destination);
                            source.start(0);
                        }
                    }
                };
            } catch (error) {
                console.error('Error loading dice roll sound:', error);
                return null;
            }
        }

        function generateClientId() {
            return 'client-' + Math.random().toString(36).substring(2, 15);
        }

        function connectClientUI() {
            document.getElementById('sessionIdContainer').style.display = 'block';
            document.getElementById('newSessionContainer').style.display = 'none';
        }


        function saveToLocalStorage() {
            if (serverClientMode === 'local') {
                const globalConfig = {
                    showSettingsGlobal,
                    hideAllExceptResources,
                    disableAllAnimations,
                    globalHideFunnyNames,
                    previousFunnyNameStates,
                    serverClientMode,
                    clientName,
                    globalHideAllImages,
                };
                localStorage.setItem('boardGameResources', JSON.stringify(resources));
                localStorage.setItem('unnamedCounter', unnamedCounter);
                localStorage.setItem('globalConfig', JSON.stringify(globalConfig));
                localStorage.setItem('clientName', clientName);
            } else if (serverClientMode === 'server' || serverClientMode === 'client') {
                const globalConfig = {
                    showSettingsGlobal,
                    hideAllExceptResources,
                    disableAllAnimations,
                    globalHideFunnyNames,
                    previousFunnyNameStates,
                    serverClientMode,
                    clientName,
                    globalHideAllImages,
                };
                localStorage.setItem('globalConfig', JSON.stringify(globalConfig));
                localStorage.setItem('clientName', clientName);
            }

            saveGlobalSettingsToLocalStorage();
        }

        function updateServerClientUI() {
            const sessionIdContainer = document.getElementById('sessionIdContainer');
            const newSessionContainer = document.getElementById('newSessionContainer');
            const serverClientButton = document.getElementById('serverClientButton');
            const serverIDDisplayContainer = document.getElementById('serverIDDisplayContainer');
            const serverClientModeSelect = document.getElementById('serverClientMode');
            const exportSdkConfigButton = document.getElementById('exportSdkConfigButton');
            const importSdkConfigButton = document.getElementById('importSdkConfigButton');
            const statusWindowContainer = document.getElementById('statusWindowContainer');
            const qrcodeCanvasContainer = document.getElementById('qrcodeCanvas');

            if (serverClientMode === 'client') {
                sessionIdContainer.style.display = 'block';
                newSessionContainer.style.display = 'none';
                serverIDDisplayContainer.style.display = 'none';
                qrcodeCanvasContainer.style.display = 'none';
                serverClientButton.textContent = '👤';
                serverClientModeSelect.style.display = 'inline-block';
                statusWindowContainer.style.display = 'block';
                if (importSdkConfigButton) importSdkConfigButton.style.display = 'inline-block';
                if (exportSdkConfigButton) exportSdkConfigButton.style.display = 'none';
            } else if (serverClientMode === 'server') {
                sessionIdContainer.style.display = 'none';
                newSessionContainer.style.display = (sessionId ? 'none' : 'block');
                serverIDDisplayContainer.style.display = (sessionId ? 'block' : 'none');
                qrcodeCanvasContainer.style.display = (sessionId ? 'block' : 'none');
                serverClientButton.textContent = '🌐';
                serverClientModeSelect.style.display = 'inline-block';
                statusWindowContainer.style.display = 'block';
                if (sessionId && exportSdkConfigButton) exportSdkConfigButton.style.display = 'inline-block';
                else if (exportSdkConfigButton) exportSdkConfigButton.style.display = 'none';
                if (importSdkConfigButton) importSdkConfigButton.style.display = 'none';
                if (sessionId) {
                    document.getElementById('serverIDDisplay').value = sessionId;
                    generateQRCode();
                }
            } else {
                sessionIdContainer.style.display = 'block';
                newSessionContainer.style.display = 'none';
                serverIDDisplayContainer.style.display = 'none';
                qrcodeCanvasContainer.style.display = 'none';
                serverClientButton.textContent = '👤';
                serverClientModeSelect.style.display = 'inline-block';
                statusWindowContainer.style.display = 'none';
                if (importSdkConfigButton) importSdkConfigButton.style.display = 'none';
                if (exportSdkConfigButton) exportSdkConfigButton.style.display = 'none';
            }
        }


        function loadFromLocalStorage() {
            const savedGlobalConfig = localStorage.getItem('globalConfig');
            if (serverClientMode === 'local') {
                const savedResources = localStorage.getItem('boardGameResources');

                if (savedResources) {
                    resources = JSON.parse(savedResources).map(processResourceData);
                    unnamedCounter = parseInt(localStorage.getItem('unnamedCounter')) || 1;
                    if (savedGlobalConfig) {
                        const config = JSON.parse(savedGlobalConfig);
                        applyGlobalConfig(config);
                        previousFunnyNameStates = config.previousFunnyNameStates || {};
                        if (config.serverClientMode) {
                            serverClientMode = config.serverClientMode;
                            document.getElementById('serverClientMode').value = serverClientMode;
                            updateServerClientUI();
                        }
                        if (config.clientName) {
                            clientName = config.clientName;
                            document.getElementById('clientNameInput').value = clientName;
                        }
                        if (config.globalHideAllImages !== undefined) {
                            globalHideAllImages = config.globalHideAllImages;
                            document.getElementById('globalHideAllImages').checked = globalHideAllImages;
                        }
                    }
                    renderResources();
                    updateVisibility();
                }
            } else if ((serverClientMode === 'client' || serverClientMode === 'server') && sessionId) {
                loadConfigFromServer();
            } else {
                if (savedGlobalConfig) {
                    const config = JSON.parse(savedGlobalConfig);
                    applyGlobalConfig(config);
                    if (config.serverClientMode) {
                        serverClientMode = config.serverClientMode;
                        document.getElementById('serverClientMode').value = config.serverClientMode;
                        updateServerClientUI();
                    }
                    if (config.clientName) {
                        clientName = config.clientName;
                        document.getElementById('clientNameInput').value = clientName;
                    }
                    if (config.globalHideAllImages !== undefined) {
                        globalHideAllImages = config.globalHideAllImages;
                        document.getElementById('globalHideAllImages').checked = globalHideAllImages;
                    }
                }
                updateServerClientUI();
            }

            checkGlobalCounterLimit();
            loadGlobalSettingsFromLocalStorage();
            loadFirebaseConfigFromCache();
        }

        function saveGlobalSettingsToLocalStorage() {
            localStorage.setItem('showSettingsGlobal', document.getElementById('showSettingsGlobal').checked);
            localStorage.setItem('disableAllAnimations', document.getElementById('disableAllAnimations').checked);
            localStorage.setItem('globalHideFunnyNames', document.getElementById('globalHideFunnyNames').checked);
            localStorage.setItem('serverClientMode', serverClientMode);
            localStorage.setItem('globalHideAllImages', document.getElementById('globalHideAllImages').checked);
        }

        function loadGlobalSettingsFromLocalStorage() {
            document.getElementById('showSettingsGlobal').checked = localStorage.getItem('showSettingsGlobal') === 'true';
            document.getElementById('disableAllAnimations').checked = localStorage.getItem('disableAllAnimations') === 'true';
            document.getElementById('globalHideFunnyNames').checked = localStorage.getItem('globalHideFunnyNames') !== 'false';
            const savedServerClientMode = localStorage.getItem('serverClientMode');
            if (savedServerClientMode) {
                serverClientMode = savedServerClientMode;
                document.getElementById('serverClientMode').value = serverClientMode;
            }
            document.getElementById('globalHideAllImages').checked = localStorage.getItem('globalHideAllImages') === 'true';

            document.getElementById('showFirebaseFieldsToggle').checked = false;

            toggleGlobalSettings();
            toggleAllAnimations();
            toggleGlobalHideFunnyNames();
            toggleGlobalHideAllImages();
            toggleFirebaseConfigVisibility();
        }


        function processResourceData(resourceData) {
            return {
                ...resourceData,
                count: typeof resourceData.count === 'number' ? resourceData.count : 0,
                customIncrement1: typeof resourceData.customIncrement1 === 'number' ? resourceData.customIncrement1 : defaultIncrement,
                customIncrement2: typeof resourceData.customIncrement2 === 'number' ? resourceData.customIncrement2 : defaultIncrement2,
                customIncrement3: typeof resourceData.customIncrement3 === 'number' ? resourceData.customIncrement3 : defaultIncrement3,
                minCount: typeof resourceData.minCount === 'number' ? resourceData.minCount : 0,
                maxCount: resourceData.maxCount == null ? Infinity : resourceData.maxCount,
                image: resourceData.image || `${STATIC_ASSET_URL}/default-image.png`,
                hideImage: typeof resourceData.hideImage === 'boolean' ? resourceData.hideImage : true,
                hideCounter: typeof resourceData.hideCounter === 'boolean' ? resourceData.hideCounter : false,
                keepOneModifier: typeof resourceData.keepOneModifier === 'boolean' ? resourceData.keepOneModifier : true,
                showRollDice: typeof resourceData.showRollDice === 'boolean' ? resourceData.showRollDice : false,
                rollDiceMin: typeof resourceData.rollDiceMin === 'number' ? resourceData.rollDiceMin : defaultMinDiceValue,
                rollDiceMax: typeof resourceData.rollDiceMax === 'number' ? resourceData.rollDiceMax : defaultMaxDiceValue,
                rollDiceIncrement: typeof resourceData.rollDiceIncrement === 'number' ? resourceData.rollDiceIncrement : 1,
                enableDiceAnimation: typeof resourceData.enableDiceAnimation === 'boolean' ? resourceData.enableDiceAnimation : true,
                numberOfDice: typeof resourceData.numberOfDice === 'number' ? resourceData.numberOfDice : 1,
                rollDiceCustomValues: Array.isArray(resourceData.rollDiceCustomValues) ? resourceData.rollDiceCustomValues : [],
                useCustomDiceValues: typeof resourceData.useCustomDiceValues === 'boolean' ? resourceData.useCustomDiceValues : false,
                useFunnyName: typeof resourceData.useFunnyName === 'boolean' ? resourceData.useFunnyName === 'boolean' : false,
                funnyName: resourceData.funnyName || "",
                previousUseFunnyName: typeof resourceData.previousUseFunnyName === 'boolean' ? resourceData.previousUseFunnyName === 'boolean' : false,
                firebaseKey: resourceData.firebaseKey
            };
        }


        function applyGlobalConfig(globalConfig) {
            showSettingsGlobal = globalConfig.showSettingsGlobal;
            hideAllExceptResources = globalConfig.hideAllExceptResources;
            disableAllAnimations = globalConfig.disableAllAnimations;
            globalHideFunnyNames = globalConfig.globalHideFunnyNames === undefined ? true : globalConfig.globalHideFunnyNames;
            previousFunnyNameStates = globalConfig.previousFunnyNameStates || {};
            clientName = globalConfig.clientName || '';
            serverClientMode = globalConfig.serverClientMode || 'client';
            globalHideAllImages = globalConfig.globalHideAllImages === undefined ? false : globalConfig.globalHideAllImages;

            document.getElementById('showSettingsGlobal').checked = showSettingsGlobal;
            document.getElementById('disableAllAnimations').checked = disableAllAnimations;
            document.getElementById('globalHideFunnyNames').checked = globalHideFunnyNames;
            document.getElementById('clientNameInput').value = clientName;
            document.getElementById('serverClientMode').value = serverClientMode;
            document.getElementById('globalHideAllImages').checked = globalHideAllImages;
            toggleGlobalCounterLimit();
        }

        function addResource() {
            const file = document.getElementById('imageUpload').files[0];
            let name = document.getElementById('resourceName').value.trim() || `Resource ${unnamedCounter++}`;

            const resource = {
                name,
                image: file ? URL.createObjectURL(file) : `${STATIC_ASSET_URL}/default-image.png`,
                count: 0,
                customIncrement1: defaultIncrement,
                customIncrement2: defaultIncrement2,
                customIncrement3: defaultIncrement3,
                minCount: 0,
                maxCount: Infinity,
                hideImage: true,
                hideCounter: false,
                keepOneModifier: true,
                showRollDice: false,
                rollDiceMin: defaultMinDiceValue,
                rollDiceMax: defaultMaxDiceValue,
                rollDiceIncrement: 1,
                enableDiceAnimation: true,
                numberOfDice: 1,
                rollDiceCustomValues: [],
                useCustomDiceValues: false,
                useFunnyName: false,
                funnyName: "",
                previousUseFunnyName: false
            };

            const firebaseResource = { ...resource, maxCount: resource.maxCount === Infinity ? null : resource.maxCount };

            if (serverClientMode === 'server' && sessionId) {
                const newResourceRef = db.ref(`sessions/${sessionId}/config`).push();
                firebaseResource.firebaseKey = newResourceRef.key;

                newResourceRef.set(firebaseResource).then(() => {
                    resources.push(resource);
                    hasUnsavedChanges = true;
                    renderResources();
                    checkGlobalCounterLimit();
                    document.getElementById('resourceName').value = "";
                    saveConfigToServer();
                });
            } else {
                resources.push(resource);
                hasUnsavedChanges = true;
                renderResources();
                saveToLocalStorage();
                checkGlobalCounterLimit();
                document.getElementById('resourceName').value = "";
            }
        }


        function renderResource(resource, index) {
            const container = document.getElementById('resources');
            const existingElement = container.querySelector(`.resource[data-resource-index="${index}"]`);
            const newElementHTML = createResourceHTML(resource, index);
            if (existingElement) {
                existingElement.outerHTML = newElementHTML;
            } else {
                container.insertAdjacentHTML('beforeend', newElementHTML)
            }


            updateOtherClientsCountsDisplay(index);
        }

        function renderResources() {
            document.getElementById('resources').innerHTML = '';
            resources.forEach((resource, index) => renderResource(resource, index));
            document.getElementById('exportButton').disabled = resources.length === 0;
            updateVisibility();
            attachEventListeners();
        }

        function generateModifierToggle(resource, index) {
            if (resource.hideCounter) return '';
            const modifierIcon = resource.keepOneModifier ? '➕' : '➖';
            return `<div class="modifier-toggle" data-resource-index="${index}" onclick="toggleKeepOneModifier(event, ${index})">${modifierIcon}</div>`
        }

        function generateResourceImage(resource) {
            if (globalHideAllImages) return '';
            return resource.hideImage ? '' : `<div class="resource-image-container">
            <img src="${resource.image}" alt="${resource.name}" class="resource-image">
        </div>`;
        }

        function generateResourceNameContainer(resource, index) {
            let displayName = resource.name;
            if (!globalHideFunnyNames && resource.useFunnyName && resource.funnyName) {
                displayName = resource.funnyName;
            }

            return `<div class="resource-name-container">
                    ${showSettingsGlobal
                        ? (resource.useFunnyName
                            ? `<input type="text" placeholder="Funny Resource Name" value="${resource.funnyName}" onblur="updateFunnyName(${index}, this.value)">`
                            : `<input type="text" placeholder="Resource Name" value="${resource.name}" onblur="updateName(${index}, this.value)">`
                          )
                        : `<span class="resource-name">${displayName}</span>`
                    }
                </div>`
        }

        function generateCounter(resource, index) {
            if (resource.hideCounter) return '';
            return `
                <div class="counter">
                    ${!resource.keepOneModifier ? `
                    <div class="counter-buttons">
                        <button onclick="updateCount(event, ${index}, -${resource.customIncrement3})">-${resource.customIncrement3}</button>
                        <button onclick="updateCount(event, ${index}, ${resource.customIncrement3})">+${resource.customIncrement3}</button>
                    </div>
                    ` : ''}
                    <div class="counter-buttons">
                        <button onclick="updateCount(event, ${index}, -${resource.customIncrement1})">-${resource.customIncrement1}</button>
                        <span class="count-display">${resource.count}</span>
                        <button onclick="updateCount(event, ${index}, ${resource.customIncrement1})">+${resource.customIncrement1}</button>
                    </div>
                    ${!resource.keepOneModifier ? `
                    <div class="counter-buttons">
                        <button onclick="updateCount(event, ${index}, -${resource.customIncrement2})">-${resource.customIncrement2}</button>
                        <button onclick="updateCount(event, ${index}, ${resource.customIncrement2})">+${resource.customIncrement2}</button>
                    </div>
                    ` : ''}
                    <div class="other-clients-counts" id="otherClientsCounts${index}">
                    </div>
                </div>
            `;
        }

        function generateDiceControls(resource, index) {
            if (!resource.showRollDice) return '';
            return `
             <div class="roll-dice" style="display: flex; justify-content: center; align-items: center; margin-top: 10px;">
                 <button class="dice-button" onclick="rollDice(${index})">🎲</button>
                 <div class="roll-result" id="rollResult${index}" style="cursor: pointer; margin-left: 10px;" title="Click to toggle between detailed result and sum">
                    ${resource.useCustomDiceValues && resource.rollDiceCustomValues.length > 0
                        ? Array(resource.numberOfDice).fill(resource.rollDiceCustomValues[resource.rollDiceCustomValues.length - 1]).join(', ')
                        : Array(resource.numberOfDice).fill(resource.rollDiceMax).join(', ')}
                 </div>
            </div>
        `;
        }

        function generateSettings(resource, index) {
            if (!showSettingsGlobal) return '';
            const counterSettingsStyle = resource.hideCounter ? 'display: none;' : '';

            return `
                <div class="settings">
                    <div class="use-funny-name-checkbox" style="${globalHideFunnyNames ? 'display: none;' : ''}">
                        Use Funny Name: <input type="checkbox" ${resource.useFunnyName ? 'checked' : ''} onchange="updateUseFunnyName(${index}, this.checked)" ${globalHideFunnyNames ? 'disabled' : ''}>
                    </div>
                    <div class="hide-image-checkbox">
                        Hide Image: <input type="checkbox" ${resource.hideImage ? 'checked' : ''} onchange="updateHideImage(${index}, this.checked)">
                    </div>
                    ${!resource.hideImage ? `<button onclick="changeImage(${index})">Change Image</button>` : ''}
                    <div class="hide-counter-checkbox">
                        Hide Counter: <input type="checkbox" ${resource.hideCounter ? 'checked' : ''} onchange="updateHideCounter(${index}, this.checked)">
                    </div>

                    <div class="counter-settings" style="${counterSettingsStyle}">
                        <div class="keep-one-modifier-checkbox">
                            Keep one Modifier: <input type="checkbox" ${resource.keepOneModifier ? 'checked' : ''} checked onchange="updateKeepOneModifier(${index}, this.checked)">
                        </div>
                        <div>
                            Increment 1: <input type="number" class="custom-increment" value="${resource.customIncrement1}" onchange="updateCustomIncrement(${index}, 1, this.value)" min="1">
                        </div>
                        ${!resource.keepOneModifier ? `
                        <div>
                            Increment 2: <input type="number" class="custom-increment" value="${resource.customIncrement2}" onchange="updateCustomIncrement(${index}, 2, this.value)" min="1">
                        </div>
                        <div>
                            Increment 3: <input type="number" class="custom-increment" value="${resource.customIncrement3}" onchange="updateCustomIncrement(${index}, 3, this.value)" min="1">
                        </div>
                        ` : ''}
                        <div>
                            Minimum Count: <input type="number" value="${resource.minCount}" onchange="updateMinCount(${index}, this.value)">
                        </div>
                        <div>
                            Maximum Count: <input type="number" value="${resource.maxCount === Infinity ? '' : resource.maxCount}" onchange="updateMaxCount(${index}, this.value)">
                        </div>
                    </div>

                    <div class="roll-dice-settings">
                        Show Roll Dice: <input type="checkbox" ${resource.showRollDice ? 'checked' : ''} onchange="updateShowRollDice(${index}, this.checked)">
                    </div>
                    ${resource.showRollDice ? `
                    <div>
                        Use Custom Dice Values: <input type="checkbox" ${resource.useCustomDiceValues ? 'checked' : ''} onchange="updateUseCustomDiceValues(${index}, this.checked)">
                    </div>
                    ${!resource.useCustomDiceValues ? `
                    <div>
                        Roll Dice Min: <input type="number" value="${resource.rollDiceMin}" onchange="updateRollDiceMin(${index}, this.value)" min="1">
                    </div>
                    <div>
                        Roll Dice Max: <input type="number" value="${resource.rollDiceMax}" onchange="updateRollDiceMax(${index}, this.value)" min="1">
                    </div>
                    <div>
                        Roll Dice Increment: <input type="number" value="${resource.rollDiceIncrement}" onchange="updateRollDiceIncrement(${index}, this.value)" min="1">
                    </div>
                    ` : `
                    <div>
                        Custom Dice Values: <input type="text" value="${resource.rollDiceCustomValues.join(', ')}" onchange="updateRollDiceCustomValues(${index}, this.value)">
                    </div>
                    `}
                    <div>
                        Number of Dice: <input type="number" value="${resource.numberOfDice}" min="1" onchange="updateNumberOfDice(${index}, this.value)">
                    </div>
                    <div>
                        Enable Dice Animation: <input type="checkbox" ${resource.enableDiceAnimation ? 'checked' : ''} onchange="updateEnableDiceAnimation(${index}, this.checked)">
                    </div>
                    ` : ''}
                    <button onclick="removeResource(${index})" class="remove-button">Remove</button>
                </div>
            `
        }


        function createResourceHTML(resource, index) {
            const resourceClass = 'resource';
            return `
                <div class="${resourceClass}" data-resource-index="${index}">
                    ${generateModifierToggle(resource, index)}
                    ${generateResourceImage(resource)}
                    ${generateResourceNameContainer(resource, index)}
                    ${generateCounter(resource, index)}
                    ${generateDiceControls(resource, index)}
                    ${generateSettings(resource, index)}
                </div>
             `;
        }

        function toggleKeepOneModifier(event, index) {
            event.stopPropagation();
            const targetResource = resources[index];
            targetResource.keepOneModifier = !targetResource.keepOneModifier;
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }


        function updateUseCustomDiceValues(index, use) {
            const targetResource = resources[index];
            targetResource.useCustomDiceValues = use;
            hasUnsavedChanges = true;
            const resultElement = document.getElementById(`rollResult${index}`);
            if (resultElement) {
                if (use && targetResource.rollDiceCustomValues.length > 0) {
                    const lastValue = targetResource.rollDiceCustomValues[targetResource.rollDiceCustomValues.length - 1];
                    resultElement.textContent = Array(targetResource.numberOfDice).fill(lastValue).join(', ');
                } else {
                    resultElement.textContent = Array(targetResource.numberOfDice).fill(targetResource.rollDiceMax).join(', ');
                }
            }
            renderResource(targetResource, index);
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateRollDiceCustomValues(index, value) {
            const targetResource = resources[index];
            targetResource.rollDiceCustomValues = value.split(',').map(v => v.trim()).filter(v => v !== '');
            hasUnsavedChanges = true;
            const resultElement = document.getElementById(`rollResult${index}`);
            if (resultElement && targetResource.useCustomDiceValues && targetResource.rollDiceCustomValues.length > 0) {
                const lastValue = targetResource.rollDiceCustomValues[targetResource.rollDiceCustomValues.length - 1];
                resultElement.textContent = Array(targetResource.numberOfDice).fill(lastValue).join(', ');
            }
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function startServer() {
            if (!db) {
                console.warn("Firebase database not initialized. Please save Firebase config first.");
                return;
            }

            sessionId = generateSessionId();
            clientName = document.getElementById('clientNameInput').value.trim();
            if (!clientName) {
                clientName = getRandomBrainrotName();
                document.getElementById('clientNameInput').value = clientName; // Set the generated name back to input
            }
            document.getElementById('sessionId').value = sessionId;
            configSavedToServer = false;

            db.ref(`sessions/${sessionId}/clients/${clientId}`).set({
                clientId: clientId,
                clientName: clientName,
            }).then(() => {
                saveConfigToServer();
                setupServerClientListeners();
                setupClientResourceListeners();
                setupServerResourceListeners();
            });

            document.getElementById('serverIDDisplay').value = sessionId;
            document.getElementById('serverIDDisplayContainer').style.display = 'block';
            document.getElementById('newSessionContainer').style.display = 'none';

            console.log(`Server started. Session ID: ${sessionId}, Name: ${clientName}`);

            updateServerClientUI();
        }

        async function connectClient() {
            sessionId = document.getElementById('sessionId').value.trim();
            clientName = document.getElementById('clientNameInput').value.trim();
            if (!clientName) {
                clientName = getRandomBrainrotName();
                document.getElementById('clientNameInput').value = clientName; // Set the generated name back to input
            }
            saveToLocalStorage();

            if (!clientName) {
                alert("Please enter a client name.");
                return;
            }

            if (sessionId) {
                // Check for duplicate client names
                const clientsRef = db.ref(`sessions/${sessionId}/clients`);
                const snapshot = await clientsRef.orderByChild('clientName').equalTo(clientName).once('value');
                if (snapshot.exists()) {
                    alert("This client name is already taken. Please choose a different name.");
                    return;
                }

                db.ref(`sessions/${sessionId}/clients/${clientId}`).set({
                    clientId: clientId,
                    clientName: clientName,
                }).then(() => {
                    loadConfigFromServer();
                    setupClientResourceListeners();
                    setupClientSideClientListeners();
                    updateServerClientUI();
                    console.log(`Client - Connected to session: ${sessionId}, Name: ${clientName}`);
                }).catch(error => {
                    console.error("Error connecting client:", error);
                    alert("Failed to connect to session. Please check the console for details.");
                });
            } else {
                alert("Please enter a Session ID.");
            }
        }

        function generateQRCode() {
            const firebaseConfig = {
                apiKey: document.getElementById('apiKey').value,
                authDomain: document.getElementById('authDomain').value,
                databaseURL: document.getElementById('databaseURL').value,
                projectId: document.getElementById('projectId').value,
                storageBucket: document.getElementById('storageBucket').value,
                messagingSenderId: document.getElementById('messagingSenderId').value,
                appId: document.getElementById('appId').value
            };

            console.log("Firebase Config for QR Code:", firebaseConfig);
            const sessionDetails = {
                sessionId: sessionId
            };

            const combinedConfig = {
                firebaseConfig: firebaseConfig,
                sessionDetails: sessionDetails
            };

            const configString = JSON.stringify(combinedConfig);
            const currentUrl = window.location.href.split('?')[0];
            const qrCodeData = `${currentUrl}?config=${encodeURIComponent(configString)}`;

            console.log("QR Code Data:", qrCodeData);

            const qrcodeContainer = document.getElementById('qrcodeCanvas');
            qrcodeContainer.innerHTML = '';

            const isDarkMode = document.body.classList.contains('dark-mode');
            const colorDark = isDarkMode ? '#ffffff' : '#000000';
            const colorLight = isDarkMode ? '#000000' : '#ffffff';


            if (!qrcode) {
                qrcode = new QRCode(qrcodeContainer, {
                    text: qrCodeData,
                    width: 300,
                    height: 300,
                    colorDark: colorDark,
                    colorLight: colorLight,
                    correctLevel: QRCode.CorrectLevel.H
                });
            } else {
                qrcode.options.colorDark = colorDark;
                qrcode.options.colorLight = colorLight;
                qrcode.makeCode(qrCodeData);
            }
        }


        function exportSdkConfigWithSession() {
            if (sdkExported) {
                console.warn("SDK config already exported. Please wait or refresh to export again.");
                return;
            }

            sdkExported = true;

            const firebaseConfig = {
                apiKey: document.getElementById('apiKey').value,
                authDomain: document.getElementById('authDomain').value,
                databaseURL: document.getElementById('databaseURL').value,
                projectId: document.getElementById('projectId').value,
                storageBucket: document.getElementById('storageBucket').value,
                messagingSenderId: document.getElementById('messagingSenderId').value,
                appId: document.getElementById('appId').value
            };
            const sessionDetails = {
                sessionId: sessionId
            };

            const combinedConfig = {
                firebaseConfig: firebaseConfig,
                sessionDetails: sessionDetails
            };

            const configStr = JSON.stringify(combinedConfig, null, 2);
            const blob = new Blob([configStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sdk-config-with-session.json';
            a.click();
            URL.revokeObjectURL(url);

            setTimeout(() => {
                sdkExported = false;
            }, 1000);
        }

        function attachEventListeners() {
            document.addEventListener('click', function (event) {
                const target = event.target;

                if (target.matches('.counter button')) {
                    event.stopPropagation();
                    const resourceIndex = parseInt(target.closest('.resource').dataset.resourceIndex);
                    let change = 0;
                    if (target.textContent === '+1') change = resources[resourceIndex].customIncrement1;
                    else if (target.textContent === '-1') change = - resources[resourceIndex].customIncrement1;
                    else if (target.textContent === '+2') change = resources[resourceIndex].customIncrement2;
                    else if (target.textContent === '-2') change = - resources[resourceIndex].customIncrement2;
                    else if (target.textContent === '+3') change = resources[resourceIndex].customIncrement3;
                    else if (target.textContent === '-3') change = - resources[resourceIndex].customIncrement3;

                    updateCount(event, resourceIndex, change);
                }

                if (target.matches('.modifier-toggle')) {
                    event.stopPropagation();
                    const resourceIndex = parseInt(target.closest('.resource').dataset.resourceIndex);
                    toggleKeepOneModifier(event, resourceIndex);
                }
                if (globalSettingsVisible && !target.closest('#globalSettings')) {
                    toggleGlobalSettingsVisibility();
                }
                if (serverClientSettingsVisible && !target.closest('#serverClientSettings')) {
                    toggleServerClientSettingsVisibility();
                }
                if (statusWindowVisible && !event.target.closest('#statusWindowContainer')) {
                    toggleStatusWindowVisibility();
                }
            });


            document.addEventListener('input', function (event) {
                const target = event.target;
                if (target.matches('.resource input')) {
                    const input = target;
                    const resourceElement = input.closest('.resource');
                    const resourceIndex = parseInt(resourceElement.dataset.resourceIndex);
                    const setting = input.parentElement.textContent.trim().split(':')[0].toLowerCase().replace(/\s/g, '');
                    const value = input.type === 'checkbox' ? input.checked : input.value;
                    updateResourceSetting(resourceIndex, setting, value);
                }
            });

            document.getElementById('addButton').addEventListener('click', addResource);
            document.getElementById('loadExampleButton').addEventListener('click', loadSelectedExample);
            document.getElementById('startButton').addEventListener('click', startServer);
            document.getElementById('connectButton').addEventListener('click', connectClient);
            document.getElementById('saveFirebaseConfig').addEventListener('click', () => {
                if (initializeFirebaseWithUserInput()) {
                    console.log("Firebase Config Saved and Initialized.");
                } else {
                    console.warn("Firebase Initialization Failed.");
                }
            });
            document.getElementById('exportSdkConfigButton').addEventListener('click', exportSdkConfigWithSession);
        }

        function updateResourceSetting(index, setting, value) {
             const targetResource = resources[index];
            switch (setting) {
                case 'hideimage': updateHideImage(index, value); break;
                case 'hidecounter': updateHideCounter(index, value); break;
                case 'keeponemodifier': updateKeepOneModifier(index, value); break;
                case 'increment1':
                case 'increment2':
                case 'increment3': updateCustomIncrement(index, parseInt(setting.slice(-1)), value); break;
                case 'minimumcount': updateMinCount(index, value); break;
                case 'maximumcount': updateMaxCount(index, value); break;
                case 'showrolldice': updateShowRollDice(index, value); break;
                case 'rolldicemin': updateRollDiceMin(index, value); break;
                case 'rolldicemax': updateRollDiceMax(index, value); break;
                case 'rolldiceincrement': updateRollDiceIncrement(index, value); break;
                case 'numberofdice': updateNumberOfDice(index, value); break;
                case 'enablediceAnimation': updateEnableDiceAnimation(index, value); break;
                case 'usecustomdicevalues': updateUseCustomDiceValues(index, value); break;
                case 'customdicevalues': updateRollDiceCustomValues(index, value); break;
                case 'usefunnyname': updateUseFunnyName(index, value); break;
            }
             if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateName(index, newName) {
            const targetResource = resources[index];
            targetResource.name = newName;
            hasUnsavedChanges = true;
            saveToLocalStorage();
            renderResource(targetResource, index);
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateFunnyName(index, newFunnyName) {
            const targetResource = resources[index];
            targetResource.funnyName = newFunnyName;
            hasUnsavedChanges = true;
            saveToLocalStorage();
            renderResource(targetResource, index);
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateCount(event, index, change) {
            event.stopPropagation();
            const targetResource = resources[index];

            if (typeof change !== 'number' || isNaN(change)) {
                console.error("Invalid change value:", change);
                return;
            }

            let potentialNewResourceCount = Math.max(targetResource.minCount, Math.min(targetResource.count + change, targetResource.maxCount === null ? Infinity : targetResource.maxCount));
            let currentTotalCount = resources.reduce((sum, resource) => sum + resource.count, 0);
            let potentialNewTotalCount = currentTotalCount - targetResource.count + potentialNewResourceCount;


            if (enableGlobalCounterLimit && potentialNewTotalCount > globalCounterLimit) {
                potentialNewResourceCount = globalCounterLimit - (currentTotalCount - targetResource.count);
                potentialNewResourceCount = Math.max(targetResource.minCount, Math.min(potentialNewResourceCount, targetResource.maxCount === null ? Infinity : targetResource.maxCount));
                if (potentialNewResourceCount < targetResource.count) {
                    document.getElementById('limitMessage').textContent = `Global counter limit (${globalCounterLimit}) reached!`;
                    document.getElementById('limitMessage').style.display = 'block';
                    return;
                }
            } else {
                document.getElementById('limitMessage').style.display = 'none';
            }


            let newCount = potentialNewResourceCount;


            if ((serverClientMode === 'client' || serverClientMode === 'server') && sessionId) {
                if (!db) {
                    console.warn("Firebase db is not initialized in updateCount (Server Mode).");
                    return;
                }
                const firebaseRef = db.ref(`sessions/${sessionId}/client_counts/${clientId}/${index}`);

                firebaseRef.set(newCount)
                    .then(() => {
                        updateOtherClientsCountsDisplay(index);
                    })
                    .catch(error => {
                        console.error('Error syncing client resource count to server:', error);
                    });
            }
            else {
                targetResource.count = newCount;
                const resourceElement = document.querySelector(`.resource[data-resource-index="${index}"] .count-display`);
                if (resourceElement) {
                    resourceElement.textContent = newCount;
                }
                saveToLocalStorage();
            }

            hasUnsavedChanges = true;
            setHideAllExceptResources(true);
            resetInactivityTimer();
            checkGlobalCounterLimit();
        }


        function updateCustomIncrement(index, incrementNumber, value) {
            const targetResource = resources[index];
            targetResource[`customIncrement${incrementNumber}`] = Math.max(1, parseInt(value) || 1);
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateMinCount(index, value) {
            const targetResource = resources[index];
            targetResource.minCount = parseInt(value) || 0;
            targetResource.count = Math.max(targetResource.minCount, targetResource.count);
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
            checkGlobalCounterLimit();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateMaxCount(index, value) {
            const targetResource = resources[index];
            targetResource.maxCount = value === '' ? null : Math.max(targetResource.minCount, parseInt(value) || 0);
            targetResource.count = Math.min(targetResource.maxCount === null ? Infinity : targetResource.maxCount, targetResource.count);
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
            checkGlobalCounterLimit();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateHideImage(index, hide) {
            const targetResource = resources[index];
            targetResource.hideImage = hide;
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateKeepOneModifier(index, keep) {
            event.stopPropagation();
            const targetResource = resources[index];
            targetResource.keepOneModifier = keep;
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateShowRollDice(index, show) {
            const targetResource = resources[index];
            targetResource.showRollDice = show;
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateRollDiceMin(index, value) {
            const targetResource = resources[index];
            targetResource.rollDiceMin = Math.max(1, parseInt(value) || 1);
            hasUnsavedChanges = true;
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateRollDiceMax(index, value) {
            const targetResource = resources[index];
            targetResource.rollDiceMax = Math.max(targetResource.rollDiceMin, parseInt(value) || targetResource.rollDiceMin);
            hasUnsavedChanges = true;
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateRollDiceIncrement(index, value) {
            const targetResource = resources[index];
            targetResource.rollDiceIncrement = Math.max(1, parseInt(value) || 1);
            hasUnsavedChanges = true;
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateNumberOfDice(index, value) {
            const targetResource = resources[index];
            targetResource.numberOfDice = Math.max(1, parseInt(value) || 1);
            hasUnsavedChanges = true;
            saveToLocalStorage();
            renderResource(targetResource, index);
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateHideCounter(index, hide) {
            const targetResource = resources[index];
            targetResource.hideCounter = hide;
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateEnableDiceAnimation(index, enable) {
            const targetResource = resources[index];
            targetResource.enableDiceAnimation = enable;
            hasUnsavedChanges = true;
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateUseFunnyName(index, use) {
            const targetResource = resources[index];
            targetResource.useFunnyName = use;
            hasUnsavedChanges = true;
            renderResource(targetResource, index);
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function displayRollResult(index, results, sum) {
            const targetResource = resources[index];
            const resultElement = document.getElementById(`rollResult${index}`);

            if (targetResource.useCustomDiceValues && targetResource.rollDiceCustomValues.length > 0) {
                resultElement.textContent = results.join(', ');
                resultElement.dataset.detailed = results.join(', ');
                resultElement.onclick = null;
                resultElement.style.cursor = 'default';
                resultElement.title = 'Custom dice values';
            } else {
                resultElement.textContent = results.join(', ');
                resultElement.dataset.sum = sum;
                resultElement.dataset.detailed = results.join(', ');
                resultElement.onclick = () => toggleRollResult(index);
                resultElement.style.cursor = 'pointer';
                resultElement.title = 'Click to toggle between detailed result and sum';
            }
        }

        function toggleRollResult(index) {
            const targetResource = resources[index];
            const resultElement = document.getElementById(`rollResult${index}`);

            if (targetResource.useCustomDiceValues && targetResource.rollDiceCustomValues.length > 0) {
                return;
            }

            if (resultElement.textContent === resultElement.dataset.sum) {
                resultElement.textContent = resultElement.dataset.detailed;
            } else {
                resultElement.textContent = resultElement.dataset.sum;
            }
        }


        async function rollDice(index) {
            const targetResource = resources[index];
            let results = [];
            let sum = 0;
            if (!diceSound) {
                diceSound = await createDiceRollSound();
            }
            if (!diceSound) return;

            if (targetResource.useCustomDiceValues && targetResource.rollDiceCustomValues.length > 0) {
                for (let i = 0; i < targetResource.numberOfDice; i++) {
                    const result = targetResource.rollDiceCustomValues[Math.floor(Math.random() * targetResource.rollDiceCustomValues.length)];
                    results.push(result);
                }
            } else {
                const min = targetResource.rollDiceMin;
                const max = targetResource.rollDiceMax;
                const increment = targetResource.rollDiceIncrement;
                const possibleValues = [];
                for (let i = min; i <= max; i += increment) {
                    possibleValues.push(i);
                }
                for (let i = 0; i < targetResource.numberOfDice; i++) {
                    const result = possibleValues[Math.floor(Math.random() * possibleValues.length)];
                    results.push(result);
                    sum += result;
                }
            }

            const resultElement = document.getElementById(`rollResult${index}`);
            const diceButton = document.querySelector(`.resource[data-resource-index="${index}"] .dice-button`);


            if (targetResource.enableDiceAnimation && !disableAllAnimations) {
                if (diceSound && diceSound.play) {
                    diceSound.play();
                }

                diceButton.classList.add('rolling');
                resultElement.textContent = '...';
                setTimeout(() => {
                    diceButton.classList.remove('rolling');
                    displayRollResult(index, results, sum);
                }, 1000);
            } else {
                displayRollResult(index, results, sum);
            }
            setHideAllExceptResources(true);
            resetInactivityTimer();
        }


        function changeImage(index) {
            const targetResource = resources[index];
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/jpeg, image/png, image/gif';
            fileInput.onchange = event => {
                const file = event.target.files[0];
                if (file) {
                    targetResource.image = URL.createObjectURL(file);
                    hasUnsavedChanges = true;
                    renderResource(targetResource, index);
                    saveToLocalStorage();
                    if (serverClientMode === 'server' && sessionId) {
                        saveConfigToServer();
                    }
                }
            };
            fileInput.click();
        }

        function removeResource(index) {
            const confirmed = confirm('Are you sure you want to remove this resource?');
            if (confirmed) {
                const resource = resources[index];
                if (resource.image && resource.image.startsWith('blob:')) {
                    URL.revokeObjectURL(resource.image);
                }
                resources.splice(index, 1);
                hasUnsavedChanges = true;
                renderResources();
                saveToLocalStorage();
                checkGlobalCounterLimit();
                if (serverClientMode === 'server' && sessionId) {
                    saveConfigToServer();
                }
            }
        }

        function exportData() {
            const exportData = {
                resources,
                enableGlobalCounterLimit: enableGlobalCounterLimit,
                globalCounterLimit: globalCounterLimit
            };
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'resources.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function triggerImport() {
            document.getElementById('importFile').click();
        }

        function importData(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    resources = importedData.resources.map(processResourceData);
                    hasUnsavedChanges = false;
                    setHideAllExceptResources(true);
                    renderResources();
                    saveToLocalStorage();
                    checkGlobalCounterLimit();
                    if (importedData.enableGlobalCounterLimit !== undefined) {
                        enableGlobalCounterLimit = importedData.enableGlobalCounterLimit;
                        document.getElementById('enableGlobalCounterLimit').checked = enableGlobalCounterLimit;
                    }
                    if (importedData.globalCounterLimit !== undefined) {
                        globalCounterLimit = importedData.globalCounterLimit;
                        document.getElementById('globalCounterLimit').value = globalCounterLimit;
                    }
                    toggleGlobalCounterLimit();
                    if (serverClientMode === 'server' && sessionId) {
                        saveConfigToServer();
                    }
                } catch (error) {
                    console.warn('Error importing data. Please make sure the file is valid JSON.');
                    console.error('Import Error:', error);
                }
            };
            reader.readAsText(file);

        }

        function populateExampleDropdown() {
            const select = document.getElementById('exampleSelect');
            select.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "Select a Game";
            select.appendChild(defaultOption);

            const clearOption = document.createElement('option');
            clearOption.value = 'clear';
            clearOption.textContent = 'Clear';
            select.appendChild(clearOption);

            fetch(`${STATIC_ASSET_URL}/examples/example_list.json`)
                .then(response => response.json())
                .then(exampleNames => {
                    exampleNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = `${name}.json`;
                        option.textContent = name;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading example list:', error));
        }

        function loadSelectedExample() {
            const exampleSelect = document.getElementById('exampleSelect');
            const exampleName = exampleSelect.value;

            if (exampleName !== 'clear' && (resources.length > 0 || hasUnsavedChanges)) {
                const confirmation = confirm("Loading a new game will clear your current resources. Are you sure you want to continue?");
                if (!confirmation) return;
            }

            if (exampleName === 'clear') {
                if (confirm("Are you sure you want to clear all resources? This action cannot be undone.")) {
                    resources = [];
                    hasUnsavedChanges = false;
                    renderResources();
                    saveToLocalStorage();
                    checkGlobalCounterLimit();
                    if (serverClientMode === 'server' && sessionId) {
                        saveConfigToServer();
                    }
                }
            } else if (exampleName) {
                fetch(`${STATIC_ASSET_URL}/examples/${exampleName}`)
                    .then(response => response.json())
                    .then(data => {
                        const resourcesData = Array.isArray(data) ? data : data.resources;
                        resources = resourcesData.map(processResourceData);
                        hasUnsavedChanges = false;
                        setHideAllExceptResources(true);
                        renderResources();
                        saveToLocalStorage();
                        checkGlobalCounterLimit();
                        exampleSelect.value = "";
                        if (serverClientMode === 'server' && sessionId) {
                            saveConfigToServer();
                        }
                    })
                    .catch(error => {
                        console.error('Failed to load example:', error);
                        console.warn('Failed to load example');
                    });
            }
        }

        function refreshExamples() {
            if (!exampleDropdownPopulated) {
                populateExampleDropdown();
                exampleDropdownPopulated = true;
            }
        }

        function toggleGlobalSettings() {
            showSettingsGlobal = document.getElementById('showSettingsGlobal').checked;
            saveGlobalSettingsToLocalStorage();
            renderResources();
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function toggleGlobalSettingsVisibility() {
            globalSettingsVisible = !globalSettingsVisible;
            document.getElementById('globalSettingsContent').style.display = globalSettingsVisible ? 'block' : 'none';
        }


        function toggleHideAllExceptResources() {
            hideAllExceptResources = !hideAllExceptResources;
            updateVisibility();
            saveToLocalStorage();
            document.getElementById('hideAllArrow').textContent = hideAllExceptResources ? '▼' : '▲';
        }

        function setHideAllExceptResources(value) {
            hideAllExceptResources = value;
            updateVisibility();
            saveToLocalStorage();
            document.getElementById('hideAllArrow').textContent = value ? '▼' : '▲';
        }

        function updateVisibility() {
            document.getElementById('controlsContainer').style.display = hideAllExceptResources ? 'none' : 'block';
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                setHideAllExceptResources(false);
            }, 5 * 60 * 1000);
        }

        function toggleAllAnimations() {
            disableAllAnimations = document.getElementById('disableAllAnimations').checked;
            saveGlobalSettingsToLocalStorage();
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function updateGlobalCounterLimit() {
            globalCounterLimit = parseInt(document.getElementById('globalCounterLimit').value) || 100;
            checkGlobalCounterLimit();
        }

        function toggleGlobalCounterLimit() {
            enableGlobalCounterLimit = document.getElementById('enableGlobalCounterLimit').checked;
            document.getElementById('globalCounterLimitContainer').style.display = enableGlobalCounterLimit ? 'block' : 'none';
            checkGlobalCounterLimit();
        }

        function toggleGlobalHideFunnyNames() {
            globalHideFunnyNames = document.getElementById('globalHideFunnyNames').checked;
            saveGlobalSettingsToLocalStorage();

            if (globalHideFunnyNames) {
                resources.forEach((resource, index) => {
                    previousFunnyNameStates[index] = resource.useFunnyName;
                    resource.previousUseFunnyName = resource.useFunnyName;
                    resource.useFunnyName = false;
                });
            } else {
                resources.forEach((resource, index) => {
                    resource.useFunnyName = resource.previousUseFunnyName;
                });
            }

            renderResources();
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }

        function toggleGlobalHideAllImages() {
            globalHideAllImages = document.getElementById('globalHideAllImages').checked;
            saveGlobalSettingsToLocalStorage();
            renderResources();
            saveToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }


        function checkGlobalCounterLimit() {
            if (!enableGlobalCounterLimit) {
                document.getElementById('limitMessage').style.display = 'none';
                return;
            }

            const totalCount = resources.reduce((sum, resource) => sum + resource.count, 0);
            const limitMessage = document.getElementById('limitMessage');
            if (totalCount > globalCounterLimit) {
                limitMessage.textContent = `Global counter limit (${globalCounterLimit}) exceeded!`;
                limitMessage.style.display = 'block';
            } else {
                limitMessage.style.display = 'none';
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const darkModeEnabled = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', darkModeEnabled.toString());
            saveGlobalSettingsToLocalStorage();
            if (serverClientMode === 'server' && sessionId) {
                saveConfigToServer();
            }
        }


        window.addEventListener('beforeunload', (event) => {
            if (hasUnsavedChanges) {
                event.preventDefault();
                event.returnValue = '';
                event.returnValue = '';
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            refreshExamples();
            loadFromLocalStorage();
            resetInactivityTimer();

            loadGlobalSettingsFromLocalStorage();
            toggleGlobalCounterLimit();
            loadFirebaseConfigFromCache();

            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').checked = true;
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('darkModeToggle').checked = false;
            }


            const serverClientModeSelect = document.getElementById('serverClientMode');
            serverClientModeSelect.addEventListener('change', handleServerClientModeChange);
            handleServerClientModeChange();
            updateServerClientUI();
            attachEventListeners();
            toggleFirebaseConfigVisibility();
            document.getElementById('showFirebaseFieldsToggle').checked = false;
            toggleFirebaseConfigVisibility();


            const urlParams = new URLSearchParams(window.location.search);
            const configParam = urlParams.get('config');
            if (configParam) {
                importSdkConfigFromURL(configParam);
            }
        });

        function setupServerClientListeners() {
            if (!sessionId || serverClientMode !== 'server' || serverListeners.clientListener) return;

            const clientsRef = db.ref(`sessions/${sessionId}/clients`);
            serverListeners.clientListener = clientsRef.on('child_added', (snapshot) => {
                const newClientId = snapshot.key;
                const clientData = snapshot.val();
                const connectedClientName = clientData.clientName;
                clientsInSession[newClientId] = connectedClientName;
                console.log(`Server - Client connected: ${connectedClientName} (${newClientId})`);
                resources.forEach((resource, index) => updateOtherClientsCountsDisplay(index));
            });

            serverListeners.removeClientListener = clientsRef.on('child_removed', (snapshot) => {
                const removedClientId = snapshot.key;
                delete clientsInSession[removedClientId];
                console.log(`Server - Client disconnected: ${removedClientId}`);
                 resources.forEach((resource, index) => updateOtherClientsCountsDisplay(index));
            });

            clientsRef.once('value', (snapshot) => {
                const initialClientsData = snapshot.val();
                if (initialClientsData) {
                    for (const clientId in initialClientsData) {
                        clientsInSession[clientId] = initialClientsData[clientId].clientName;
                    }
                }
            });
        }


        function handleServerClientModeChange() {
            serverClientMode = document.getElementById('serverClientMode').value;
            updateServerClientUI();
            saveToLocalStorage();
            cleanupFirebaseListeners();
            sessionId = null;
            initialLoad = true;
            configSavedToServer = false;
            document.getElementById('serverIDDisplayContainer').style.display = 'none';
            document.getElementById('newSessionContainer').style.display = 'block';
            clientsInSession = {};
            cleanupClientSideClientListeners();
            otherClientsResourceCounts = {};
            resources.forEach((resource, index) => updateOtherClientsCountsDisplay(index));

            if (serverClientMode === 'client') {
                connectClientUI();
                setupClientResourceListeners();
                setupClientSideClientListeners();
            } else if (serverClientMode === 'server') {
                setupServerResourceListeners();
            } else {
                serverClientMode = 'local';
                updateServerClientUI();
                loadFromLocalStorage();
            }
            updateServerClientUI();
        }


        function cleanupFirebaseListeners() {
            if (serverListeners.clientListener) {
                db.ref(`sessions/${sessionId}/clients`).off('child_added', serverListeners.clientListener);
                serverListeners.clientListener = null;
            }
            if (serverListeners.removeClientListener) {
                db.ref(`sessions/${sessionId}/clients`).off('child_removed', serverListeners.removeClientListener);
                serverListeners.removeClientListener = null;
            }
            if (serverListeners.resourceListener) {
                db.ref(`sessions/${sessionId}/client_counts`).off('value', serverListeners.resourceListener);
                serverListeners.resourceListener = null;
            }

            if (clientListeners.configListener) {
                db.ref(`sessions/${sessionId}/config`).off('value', clientListeners.configListener);
                clientListeners.configListener = null;
            }
            if (clientListeners.countsListener) {
                db.ref(`sessions/${sessionId}/client_counts`).off('value', clientListeners.countsListener);
                clientListeners.countsListener = null;
            }
            cleanupClientSideClientListeners();
        }

        function cleanupClientSideClientListeners() {

            if (clientListeners.clientListListener) {

                db.ref(`sessions/${sessionId}/clients`).off('value', clientListeners.clientListListener);

                clientListeners.clientListListener = null;

            }

            }



        function setupClientSideClientListeners() {

            if (!sessionId || serverClientMode !== 'client' || clientListeners.clientListListener) return;


            const clientsRef = db.ref(`sessions/${sessionId}/clients`);


            clientListeners.clientListListener = clientsRef.on('value', (snapshot) => {
                const clientsData = snapshot.val();
                clientsInSession = {};
                if (clientsData) {
                    for (const clientIdFB in clientsData) {
                        clientsInSession[clientIdFB] = clientsData[clientIdFB].clientName;
                    }
                }
                 resources.forEach((resource, index) => updateOtherClientsCountsDisplay(index));

            }, (error) => {

                console.error("Error fetching client list for client-side clientsInSession:", error);

            });
        }


        function generateSessionId() {
            return 'session-' + Math.random().toString(36).substring(2, 10).toUpperCase();
        }

        function saveConfigToServer() {
            if (!sessionId || serverClientMode !== 'server') return;

            const firebaseResources = resources.map(resource => {
                const resourceData = {
                    name: resource.name,
                    image: resource.image,
                    count: resource.count,
                    customIncrement1: resource.customIncrement1,
                    customIncrement2: resource.customIncrement2,
                    customIncrement3: resource.customIncrement3,
                    minCount: resource.minCount,
                    maxCount: resource.maxCount === Infinity ? null : resource.maxCount,
                    hideImage: resource.hideImage,
                    hideCounter: resource.hideCounter,
                    keepOneModifier: resource.keepOneModifier,
                    showRollDice: resource.showRollDice,
                    rollDiceMin: resource.rollDiceMin,
                    rollDiceMax: resource.rollDiceMax,
                    rollDiceIncrement: resource.rollDiceIncrement,
                    enableDiceAnimation: resource.enableDiceAnimation,
                    numberOfDice: resource.numberOfDice,
                    rollDiceCustomValues: resource.rollDiceCustomValues,
                    useCustomDiceValues: resource.useCustomDiceValues,
                    useFunnyName: resource.useFunnyName,
                    funnyName: resource.funnyName,
                    previousUseFunnyName: resource.previousUseFunnyName,
                };
                if (resource.firebaseKey) {
                    resourceData.firebaseKey = resource.firebaseKey;
                }
                return resourceData;
            });

            db.ref(`sessions/${sessionId}/config`).set(firebaseResources);
            db.ref(`sessions/${sessionId}/gameSettings`).set({
                enableGlobalCounterLimit: enableGlobalCounterLimit,
                globalCounterLimit: globalCounterLimit
            })
                .then(() => {
                    configSavedToServer = true;
                    initializeServerCounts();
                })
                .catch(error => {
                    console.error('Error saving configuration to server:', error);
                    console.warn('Failed to save configuration to server.');
                });
        }

        function initializeServerCounts() {
            if (!sessionId || serverClientMode !== 'server') return;

            const serverCounts = {};
            resources.forEach((resource, index) => {
                serverCounts[index] = resource.count;
            });

            db.ref(`sessions/${sessionId}/client_counts/${clientId}`).set(serverCounts)
                .then(() => console.log("Server's initial counts initialized in client_counts."))
                .catch(error => console.error("Error initializing server counts:", error));
        }

        function loadConfigFromServer() {
            if (!sessionId) {
                console.warn('No Session ID provided to load configuration from server.');
                return;
            }
            if (clientListeners.configListener) {
                db.ref(`sessions/${sessionId}/config`).off('value', clientListeners.configListener)
            }
            clientListeners.configListener = db.ref(`sessions/${sessionId}/config`).once('value', snapshot => {
                const serverConfig = snapshot.val();
                if (serverConfig) {
                    resources = Object.values(serverConfig).map(processResourceData);
                    renderResources();

                    if (initialLoad && (serverClientMode === 'client' || serverClientMode === 'server')) {
                        const clientCounts = {};
                        resources.forEach((resource, index) => {
                            clientCounts[index] = resource.count;
                        });
                        db.ref(`sessions/${sessionId}/client_counts/${clientId}`).set(clientCounts)
                            .then(() => {
                                setupClientResourceListeners();
                                initialLoad = false;
                            })
                            .catch(error => console.error("Error initializing client counts:", error));
                    }


                } else {
                    resources = [];
                    renderResources();
                    console.warn('No configuration found for this Session ID on the server.');
                    console.log('No configuration found on server.');
                }
            }, error => {
                console.error('Error loading configuration from server:', error);
                console.warn('Failed to load configuration from server.');
            });

             db.ref(`sessions/${sessionId}/gameSettings`).once('value', snapshot => {
                const gameSettings = snapshot.val();
                if (gameSettings) {
                    enableGlobalCounterLimit = gameSettings.enableGlobalCounterLimit === undefined ? false : gameSettings.enableGlobalCounterLimit;
                    globalCounterLimit = gameSettings.globalCounterLimit === undefined ? 100 : gameSettings.globalCounterLimit;
                    document.getElementById('enableGlobalCounterLimit').checked = enableGlobalCounterLimit;
                    document.getElementById('globalCounterLimit').value = globalCounterLimit;
                    toggleGlobalCounterLimit();
                    toggleGlobalHideAllImages();
                } else {
                    console.log('No game settings found on server, using defaults.');
                }
            });
        }

        function setupServerResourceListeners() {
            if (!sessionId || serverClientMode !== 'server' || serverListeners.resourceListener) return;

            serverListeners.resourceListener = db.ref(`sessions/${sessionId}/client_counts`).on('value', (snapshot) => {
                const countsData = snapshot.val();
                if (countsData) {
                    otherClientsResourceCounts = {};
                    for (const clientFirebaseId in countsData) {
                        if (clientFirebaseId !== clientId) {
                            otherClientsResourceCounts[clientFirebaseId] = countsData[clientFirebaseId];
                        }
                    }
                    resources.forEach((resource, index) => {
                        updateOtherClientsCountsDisplay(index);
                    });
                }
            });
        }


        function setupClientResourceListeners() {
            if (!sessionId || !['client', 'server'].includes(serverClientMode) || clientListeners.countsListener) {
                return;
            }


            clientListeners.countsListener = db.ref(`sessions/${sessionId}/client_counts`).on('value', (snapshot) => {
                const countsData = snapshot.val();
                if (countsData) {
                    otherClientsResourceCounts = {};
                    for (const clientFirebaseId in countsData) {
                        if (clientFirebaseId !== clientId) {
                            otherClientsResourceCounts[clientFirebaseId] = countsData[clientFirebaseId];
                        }
                    }
                    for (const resourceIndex in resources) {
                        if (countsData[clientId] && countsData[clientId][resourceIndex] !== undefined) {
                            const countValue = countsData[clientId][resourceIndex];
                            resources[resourceIndex].count = countValue;
                        }
                        updateOtherClientsCountsDisplay(resourceIndex);
                    }
                    renderResources();
                } else {
                    otherClientsResourceCounts = {};
                    resources.forEach((resource, index) => updateOtherClientsCountsDisplay(index));
                    renderResources();
                }
            }, (error) => {
                console.error("Error in client counts listener:", error);
            });
        }


        function updateOtherClientsCountsDisplay(resourceIndex) {
            const displayElement = document.getElementById(`otherClientsCounts${resourceIndex}`);
            if (!displayElement) return;

            let displayHTML = '';
            let hasCounts = false;

            for (const clientFirebaseId in otherClientsResourceCounts) {
                const clientCounts = otherClientsResourceCounts[clientFirebaseId];
                 if (clientCounts && clientCounts[resourceIndex] !== undefined) {
                    const currentClientName = clientsInSession[clientFirebaseId] || 'Unknown Client';
                    displayHTML += `<p>${currentClientName}: ${clientCounts[resourceIndex]}</p>`;
                    hasCounts = true;
                }
            }

            if (hasCounts) {
                displayElement.innerHTML = displayHTML;
                displayElement.style.display = 'block';
            } else {
                displayElement.innerHTML = '';
                displayElement.style.display = 'none';
            }
        }


        function triggerImportSdkConfig() {
            document.getElementById('importSdkConfigFile').click();
        }

        function importSdkConfigAndJoin(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const sdkConfig = JSON.parse(e.target.result);
                    if (sdkConfig && sdkConfig.firebaseConfig && sdkConfig.sessionDetails && sdkConfig.sessionDetails.sessionId) {
                        document.getElementById('apiKey').value = sdkConfig.firebaseConfig.apiKey || '';
                        document.getElementById('authDomain').value = sdkConfig.firebaseConfig.authDomain || '';
                        document.getElementById('databaseURL').value = sdkConfig.firebaseConfig.databaseURL || '';
                        document.getElementById('projectId').value = sdkConfig.firebaseConfig.projectId || '';
                        document.getElementById('storageBucket').value = sdkConfig.firebaseConfig.storageBucket || '';
                        document.getElementById('messagingSenderId').value = sdkConfig.firebaseConfig.messagingSenderId || '';
                        document.getElementById('appId').value = sdkConfig.firebaseConfig.appId || '';

                        if (initializeFirebaseWithUserInput()) {
                            console.log("Firebase re-initialized after SDK config import.");
                            document.getElementById('sessionId').value = sdkConfig.sessionDetails.sessionId;
                            connectClient();
                        } else {
                            console.warn("Firebase Initialization Failed, cannot join session.");
                        }
                    } else {
                        console.warn("Invalid SDK configuration file.");
                    }
                } catch (error) {
                    console.warn("Error importing SDK configuration.");
                    console.error("SDK config import error:", error);
                }
            };
            reader.onerror = function(error) {
                console.warn("Error reading the SDK configuration file.");
                console.error("File read error:", error);
            };
            reader.readAsText(file);
        }

        function importSdkConfigFromURL(configParam) {

            try {
                const sdkConfig = JSON.parse(decodeURIComponent(configParam));


                if (sdkConfig && sdkConfig.firebaseConfig && sdkConfig.sessionDetails && sdkConfig.sessionDetails.sessionId) {
                    document.getElementById('apiKey').value = sdkConfig.firebaseConfig.apiKey || '';
                    document.getElementById('authDomain').value = sdkConfig.firebaseConfig.authDomain || '';
                    document.getElementById('databaseURL').value = sdkConfig.firebaseConfig.databaseURL || '';
                    document.getElementById('projectId').value = sdkConfig.firebaseConfig.projectId || '';
                    document.getElementById('storageBucket').value = sdkConfig.firebaseConfig.storageBucket || '';
                    document.getElementById('messagingSenderId').value = sdkConfig.firebaseConfig.messagingSenderId || '';
                    document.getElementById('appId').value = sdkConfig.firebaseConfig.appId || '';

                    if (initializeFirebaseWithUserInput()) {
                        console.log("Firebase re-initialized from URL config.");
                        document.getElementById('sessionId').value = sdkConfig.sessionDetails.sessionId;
                        connectClient();
                    } else {
                        console.warn("Firebase Initialization Failed from URL config, cannot join session.");
                    }
                } else {
                    console.warn("Invalid SDK configuration in URL.");
                }
            } catch (error) {
                console.warn("Error importing SDK configuration from URL:", error);
                console.error("SDK config URL import error:", error);
            }
        }
    </script>
</body>

</html>